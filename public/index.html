<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–ó –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä - –ß–∞—Ç-–±–æ—Ç</title>
    <style>
        [data-color-scheme="dark"] {
            --color-gray-400-rgb: 119, 124, 124;
            --color-teal-300-rgb: 50, 184, 198;
            --color-gray-300-rgb: 167, 169, 169;
            --color-gray-200-rgb: 245, 245, 245;
            --color-background: #1a1a1a;
            --color-surface: #252525;
            --color-text: #ffffff;
            --color-text-secondary: #b0b0b0;
            --color-primary: #2A9A9F;
            --color-primary-hover: #1D7478;
            --color-border: #404040;
            --color-card-border: rgba(255, 255, 255, 0.1);
            --color-card-border-inner: rgba(255, 255, 255, 0.08);
        }

        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-teal-800: rgba(41, 150, 161, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;
            --color-orange-500-rgb: 168, 75, 47;
            --color-orange-400-rgb: 230, 129, 97;
            --color-bg-1: rgba(59, 130, 246, 0.08);
            --color-bg-2: rgba(245, 158, 11, 0.08);
            --color-bg-3: rgba(34, 197, 94, 0.08);
            --color-bg-4: rgba(239, 68, 68, 0.08);
            --color-bg-5: rgba(147, 51, 234, 0.08);
            --color-bg-6: rgba(249, 115, 22, 0.08);
            --color-bg-7: rgba(236, 72, 153, 0.08);
            --color-bg-8: rgba(6, 182, 212, 0.08);
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-warning: var(--color-orange-500);
            --color-info: var(--color-slate-500);
            --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
            --focus-ring: 0 0 0 3px var(--color-focus-ring);
            --focus-outline: 2px solid var(--color-primary);
            --font-family-base: "Segoe UI", -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            --font-size-base: 14px;
            --font-size-sm: 12px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --space-4: 4px;
            --space-6: 6px;
            --space-8: 8px;
            --space-10: 10px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;
            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family-base);
            background: #1a1a1a;
            color: #ffffff;
            min-height: 100vh;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        body[data-color-scheme="dark"] {
            background: #1a1a1a;
            color: #ffffff;
        }

        .container {
            background: #252525;
            border-radius: 0;
            box-shadow: none;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: #1f1f1f;
            color: #ffffff;
            padding: var(--space-20);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border-bottom: 1px solid #404040;
        }

        .header-left {
            text-align: left;
        }

        .header h1 {
            font-size: var(--font-size-2xl);
            margin: 0;
            color: #ffffff;
        }

        .header p {
            font-size: var(--font-size-sm);
            opacity: 0.7;
            margin: 4px 0 0 0;
            color: #b0b0b0;
        }

        .header-right {
            display: flex;
            align-items: center;
        }

        .btn-reset {
            background: #2A9A9F;
            color: #ffffff;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-reset:hover {
            background: #1D7478;
            transform: translateY(-1px);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-20);
            display: flex;
            flex-direction: column;
            gap: var(--space-16);
        }

        .message {
            display: flex;
            gap: var(--space-12);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xl);
            flex-shrink: 0;
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, var(--color-primary), var(--color-teal-700));
        }

        .message-avatar svg {
            width: 20px;
            height: 20px;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }

        .message-content {
            max-width: 70%;
        }

        .message-bubble {
            padding: var(--space-12) var(--space-16);
            border-radius: var(--radius-md);
            word-wrap: break-word;
        }

        .message.bot .message-bubble {
            background: #2d2d2d;
            color: #ffffff;
            border-bottom-left-radius: var(--space-4);
            border: 1px solid #404040;
        }

        .message.user .message-bubble {
            background: #2A9A9F;
            color: #ffffff;
            border-bottom-right-radius: var(--space-4);
        }

        .message-actions {
            margin-top: var(--space-8);
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-8);
        }

        .btn {
            padding: var(--space-8) var(--space-16);
            border: none;
            border-radius: var(--radius-base);
            cursor: pointer;
            font-size: var(--font-size-sm);
            font-family: var(--font-family-base);
            transition: all 0.3s ease;
            display: inline-block;
        }

        .btn-primary {
            background: #2A9A9F;
            color: #ffffff;
        }

        .btn-primary:hover {
            background: #1D7478;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(42, 154, 159, 0.4);
        }

        .btn-secondary {
            background: #2d2d2d;
            color: #ffffff;
            border: 1px solid #404040;
        }

        .btn-secondary:hover {
            background: #3a3a3a;
            border-color: #2A9A9F;
        }

        .btn-small {
            padding: var(--space-6) var(--space-12);
            font-size: var(--font-size-sm);
        }

        .btn-info {
            background: #2d2d2d;
            color: #2A9A9F;
            border: 1px solid #2A9A9F;
        }

        .btn-info:hover {
            background: rgba(42, 154, 159, 0.15);
        }

        .input-container {
            padding: var(--space-16);
            background: #1f1f1f;
            border-top: 1px solid #404040;
            display: flex;
            gap: var(--space-12);
        }

        .input-container input,
        .input-container textarea {
            flex: 1;
            padding: var(--space-12);
            border: 1px solid #404040;
            border-radius: var(--radius-base);
            font-family: var(--font-family-base);
            font-size: var(--font-size-md);
            resize: none;
            background: #2d2d2d;
            color: #ffffff;
        }

        .input-container input:focus,
        .input-container textarea:focus {
            outline: none;
            border-color: #2A9A9F;
            box-shadow: 0 0 0 3px rgba(42, 154, 159, 0.3);
        }

        .color-palette {
            display: flex;
            gap: var(--space-8);
            flex-wrap: wrap;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-base);
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-md);
        }

        .color-option.selected {
            border-color: var(--color-text);
            transform: scale(1.15);
        }

        .template-form {
            background: #2d2d2d;
            padding: var(--space-20);
            border-radius: var(--radius-md);
            margin-top: var(--space-16);
            border: 1px solid #404040;
        }

        .form-group {
            margin-bottom: var(--space-16);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--space-8);
            color: #ffffff;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: var(--space-12);
            border: 1px solid #404040;
            border-radius: var(--radius-base);
            font-family: var(--font-family-base);
            font-size: var(--font-size-md);
            background: #1f1f1f;
            color: #ffffff;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .typing-indicator {
            display: flex;
            gap: var(--space-6);
            padding: var(--space-12);
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-text-secondary);
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .image-preview {
            max-width: 100%;
            border-radius: var(--radius-base);
            margin-top: var(--space-8);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .edit-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-8);
        }

        .hidden {
            display: none;
        }

        .message-hint {
            margin-top: var(--space-8);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            font-style: italic;
            padding-left: var(--space-8);
        }

        .color-palette-grid {
            display: flex;
            flex-direction: column;
            gap: var(--space-12);
            margin-top: var(--space-12);
        }

        .color-palette-item {
            display: flex;
            align-items: center;
            gap: var(--space-12);
            padding: var(--space-12);
            border: 2px solid transparent;
            border-radius: var(--radius-base);
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--color-surface);
        }

        .color-palette-item:hover {
            border-color: var(--color-primary);
            transform: translateX(4px);
        }

        .color-palette-item.selected {
            border-color: var(--color-primary);
            background: var(--color-bg-1);
        }

        .color-palette-colors {
            display: flex;
            gap: var(--space-4);
            flex: 1;
        }

        .color-palette-swatch {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--color-border);
        }

        .color-palette-name {
            font-weight: 500;
            min-width: 120px;
        }

        .uploaded-files-count {
            margin-top: var(--space-8);
            padding: var(--space-8) var(--space-12);
            background: var(--color-bg-3);
            border-radius: var(--radius-base);
            font-size: var(--font-size-sm);
            color: var(--color-text);
        }

        .summary-section {
            background: #2d2d2d;
            padding: var(--space-16);
            border-radius: var(--radius-md);
            margin-top: var(--space-12);
            border: 1px solid #404040;
        }

        .color-picker-container {
            margin-top: var(--space-12);
            padding: var(--space-12);
            background: #2d2d2d;
            border-radius: var(--radius-base);
            border: 1px solid #404040;
        }

        .custom-colors-section {
            margin-top: var(--space-16);
        }

        .custom-color-item {
            display: inline-flex;
            align-items: center;
            gap: var(--space-8);
            margin: var(--space-4);
            padding: var(--space-8);
            background: #1f1f1f;
            border-radius: var(--radius-base);
            border: 1px solid #404040;
        }

        .custom-color-swatch {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            border: 1px solid #404040;
        }

        .custom-color-hex {
            font-family: var(--font-family-mono);
            font-size: var(--font-size-sm);
            color: #b0b0b0;
        }

        .btn-remove-color {
            background: transparent;
            border: none;
            color: #ff4444;
            cursor: pointer;
            font-size: 16px;
            padding: 0 4px;
        }

        .btn-add-color {
            background: #2A9A9F;
            color: #ffffff;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-base);
            cursor: pointer;
            font-size: 14px;
            margin-top: var(--space-8);
        }

        .btn-add-color:hover {
            background: #1D7478;
        }

        .other-input-container {
            display: inline-flex;
            gap: var(--space-8);
            align-items: center;
        }

        .other-input-container input {
            padding: var(--space-8) var(--space-12);
            border: 1px solid #404040;
            border-radius: var(--radius-base);
            background: #2d2d2d;
            color: #ffffff;
            font-size: var(--font-size-sm);
        }

        .btn-add-other {
            background: #2A9A9F;
            color: #ffffff;
            border: none;
            padding: 8px 12px;
            border-radius: var(--radius-base);
            cursor: pointer;
            font-size: 14px;
        }

        .tabs-container {
            display: flex;
            gap: var(--space-8);
            margin-bottom: var(--space-12);
            border-bottom: 1px solid #404040;
        }

        .tab-button {
            background: transparent;
            border: none;
            padding: var(--space-12) var(--space-16);
            cursor: pointer;
            color: #b0b0b0;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: #2A9A9F;
            border-bottom-color: #2A9A9F;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .link-input-container {
            display: flex;
            gap: var(--space-8);
            margin-bottom: var(--space-8);
        }

        .link-input-container input {
            flex: 1;
            padding: var(--space-8) var(--space-12);
            border: 1px solid #404040;
            border-radius: var(--radius-base);
            background: #2d2d2d;
            color: #ffffff;
        }

        .links-list {
            margin-top: var(--space-12);
        }

        .link-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-8);
            background: #1f1f1f;
            border-radius: var(--radius-base);
            margin-bottom: var(--space-4);
            border: 1px solid #404040;
        }

        .link-item a {
            color: #2A9A9F;
            text-decoration: none;
            font-size: var(--font-size-sm);
        }

        .btn-remove-link {
            background: transparent;
            border: none;
            color: #ff4444;
            cursor: pointer;
            padding: 4px 8px;
        }

        .summary-item {
            padding: var(--space-8) 0;
            border-bottom: 1px solid var(--color-card-border-inner);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-weight: 500;
            color: var(--color-text);
            margin-bottom: var(--space-4);
        }

        .summary-value {
            color: var(--color-text-secondary);
        }

        .selected-colors-list {
            margin-top: var(--space-16);
            padding: var(--space-16);
            background: #1f1f1f;
            border-radius: var(--radius-base);
            border: 1px solid #404040;
        }

        .selected-colors-list h4 {
            margin-bottom: var(--space-12);
            color: #ffffff;
            font-size: var(--font-size-md);
        }

        .selected-colors-grid {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-12);
        }

        .selected-color-item {
            display: flex;
            align-items: center;
            gap: var(--space-8);
            padding: var(--space-8) var(--space-12);
            background: #2d2d2d;
            border-radius: var(--radius-base);
            border: 1px solid #404040;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .selected-color-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .selected-color-swatch {
            width: 50px;
            height: 50px;
            border-radius: var(--radius-sm);
            border: 2px solid #404040;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .selected-color-hex {
            font-family: monospace;
            font-size: var(--font-size-sm);
            color: #b0b0b0;
            min-width: 70px;
        }

        .btn-remove-selected-color {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: #ff4444;
            transition: all 0.3s ease;
        }

        .btn-remove-selected-color:hover {
            color: #ff0000;
            transform: scale(1.1);
        }

        .btn-remove-selected-color svg {
            width: 18px;
            height: 18px;
        }

        .error-message {
            color: #ff4444;
            font-size: var(--font-size-sm);
            margin-top: var(--space-8);
            padding: var(--space-8);
            background: rgba(255, 68, 68, 0.1);
            border-radius: var(--radius-base);
            border: 1px solid rgba(255, 68, 68, 0.3);
        }

        .uploaded-image-item {
            position: relative;
            display: inline-block;
            margin: var(--space-8);
        }

        .uploaded-image-item img {
            max-width: 150px;
            max-height: 150px;
            border-radius: var(--radius-base);
            border: 1px solid #404040;
        }

        .btn-remove-image {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(255, 68, 68, 0.9);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .btn-remove-image:hover {
            background: #ff0000;
            transform: scale(1.1);
        }

        .btn-remove-image svg {
            width: 14px;
            height: 14px;
            stroke: white;
        }

        .ai-questions-container {
            background: #2d2d2d;
            padding: var(--space-16);
            border-radius: var(--radius-md);
            border: 1px solid #404040;
            margin-top: var(--space-12);
        }

        .ai-question {
            margin-bottom: var(--space-16);
        }

        .ai-question label {
            display: block;
            margin-bottom: var(--space-8);
            color: #2A9A9F;
            font-weight: 500;
        }

        .ai-question input,
        .ai-question textarea {
            width: 100%;
            padding: var(--space-12);
            border: 1px solid #404040;
            border-radius: var(--radius-base);
            background: #1f1f1f;
            color: #ffffff;
            font-family: var(--font-family-base);
        }

        .ai-question textarea {
            min-height: 80px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>–¢–ó –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</h1>
                <p>–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è</p>
            </div>
            <div class="header-right">
                <button class="btn-reset" onclick="resetApp()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px; vertical-align: middle;">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                    </svg>
                    –ù–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞
                </button>
            </div>
        </div>
        <div class="chat-container" id="chatContainer"></div>
        <div class="input-container" id="inputContainer">
            <input type="text" id="userInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç...">
            <button class="btn btn-primary" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        // YandexGPT Configuration - used from backend server
        // API URL can be set via environment variable
        

        const STATE = {
            mode: null,
            questionIndex: 0,
            answers: {},
            contactInfo: {},
            currentQuestion: null,
            waitingForDetail: false,
            selectedColors: [],
            customColors: [],
            selectedPalette: null,
            uploadedImages: [],
            uploadedFiles: [],
            uploadedLinks: [],
            conversationHistory: [],
            askedQuestions: new Set(),
            isEditing: false,
            showingOtherInput: {},
            contactInfoSaved: false,
            detectedSocialMedia: false
        };

        const COLOR_PALETTES = [
            { name: '–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è', colors: ['#1F2937', '#3B82F6', '#10B981', '#F59E0B', '#EF4444'] },
            { name: '–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è', colors: ['#000000', '#FFFFFF', '#808080', '#D3D3D3', '#A8A8A8'] },
            { name: '–Ø—Ä–∫–∞—è', colors: ['#FF006E', '#FB5607', '#FFBE0B', '#8338EC', '#3A86FF'] },
            { name: '–ü–∞—Å—Ç–µ–ª—å', colors: ['#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAE1FF', '#E0BBE4'] },
            { name: '–¢–µ–º–Ω–∞—è', colors: ['#0D0221', '#3A0CA3', '#5A189A', '#C1121F', '#FDF0D5'] },
            { name: '–ü—Ä–∏—Ä–æ–¥–Ω–∞—è', colors: ['#2D5016', '#7CB342', '#8D6E63', '#FFB300', '#5D4037'] },
            { name: '–û–∫–µ–∞–Ω', colors: ['#006064', '#00ACC1', '#26C6DA', '#0097A7', '#00838F'] },
            { name: '–ó–∞–∫–∞—Ç', colors: ['#FF6F00', '#FF8F00', '#FFA726', '#FFB74D', '#FF6E40'] }
        ];

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        const STYLES = {
            minimalism: '–ú–∏–Ω–∏–º–∞–ª–∏–∑–º',
            vibrant: '–Ø—Ä–∫–∏–µ —Ü–≤–µ—Ç–∞',
            geometry: '–ì–µ–æ–º–µ—Ç—Ä–∏—è',
            classic: '–ö–ª–∞—Å—Å–∏–∫–∞',
            modern: '–ú–æ–¥–µ—Ä–Ω'
        };

        const MODES = {
            graphic: { name: '–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω'},
            web: { name: '–í–µ–±-–¥–∏–∑–∞–π–Ω' },
            polygraphy: { name: '–ü–æ–ª–∏–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω'},
            template: { name: '–®–∞–±–ª–æ–Ω'}
        };

        function addMessage(text, isUser = false, hasDetailButton = false, hint = null) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            if (isUser) {
                avatar.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>';
            } else {
                avatar.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="10" rx="2"></rect><circle cx="12" cy="5" r="2"></circle><path d="M12 7v4"></path><line x1="8" y1="16" x2="8" y2="16"></line><line x1="16" y1="16" x2="16" y2="16"></line></svg>';
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.innerHTML = text;
            
            contentDiv.appendChild(bubble);
            
            if (hint && !isUser) {
                const hintDiv = document.createElement('div');
                hintDiv.className = 'message-hint';
                hintDiv.textContent = hint;
                contentDiv.appendChild(hintDiv);
            }
            
            if (hasDetailButton && !isUser) {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                const detailBtn = document.createElement('button');
                detailBtn.className = 'btn btn-info btn-small';
                detailBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>–ü–æ–¥—Ä–æ–±–Ω–µ–µ';
                detailBtn.onclick = () => explainQuestion();
                actionsDiv.appendChild(detailBtn);
                contentDiv.appendChild(actionsDiv);
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);
            
            // Smooth auto-scroll
            setTimeout(() => {
                chatContainer.scrollTo({
                    top: chatContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        function addTypingIndicator() {
            const chatContainer = document.getElementById('chatContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.id = 'typing-indicator';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'ü§ñ';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            
            bubble.appendChild(typingIndicator);
            contentDiv.appendChild(bubble);
            typingDiv.appendChild(avatar);
            typingDiv.appendChild(contentDiv);
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        function addButtons(buttons) {
            const chatContainer = document.getElementById('chatContainer');
            const lastMessage = chatContainer.lastElementChild;
            
            if (lastMessage && lastMessage.classList.contains('bot')) {
                const contentDiv = lastMessage.querySelector('.message-content');
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                
                buttons.forEach(btn => {
                    const button = document.createElement('button');
                    button.className = `btn ${btn.class || 'btn-secondary'}`;
                    if (btn.icon) {
                        button.innerHTML = `${btn.icon}<span style="margin-left: 6px;">${btn.text}</span>`;
                    } else {
                        button.textContent = btn.text;
                    }
                    button.onclick = btn.action;
                    actionsDiv.appendChild(button);
                });
                
                contentDiv.appendChild(actionsDiv);
            }
        }

        async function callYandexGPT(prompt) {
            try {
                // Get API URL from environment or use default
                const apiUrl = window.API_URL || '/api/enhance';

                const response = await fetch('/api/enhance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });

                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }

                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }

                return data.text;
            } catch (error) {
                console.error('YandexGPT Error:', error);
                return '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ YandexGPT. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
            }
        }

        // Alias for backward compatibility
        const callGeminiAPI = callYandexGPT;

        async function explainQuestion() {
            if (!STATE.currentQuestion) return;
            
            const questions = getQuestionsForMode(STATE.mode);
            const currentQ = questions.find(q => (q.key || q.text) === STATE.currentQuestion || q.text === STATE.currentQuestion);
            
            if (!currentQ || !currentQ.detailText) {
                addMessage('–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.', false);
                return;
            }
            
            STATE.waitingForDetail = true;
            addMessage(currentQ.detailText, false, false);
            STATE.waitingForDetail = false;
        }

        function resetApp() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                location.reload();
            }
        }

        function startChat() {
            document.body.setAttribute('data-color-scheme', 'dark');
            addMessage('–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –≤–∞–º —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:', false);
            
            const buttons = [
                { text: `${MODES.graphic.name}`, action: () => selectMode('graphic'), class: 'btn-primary', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>' },
                { text: `${MODES.web.name}`, action: () => selectMode('web'), class: 'btn-primary', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>' },
                { text: `${MODES.polygraphy.name}`, action: () => selectMode('polygraphy'), class: 'btn-primary', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>' },
                { text: `${MODES.template.name}`, action: () => selectMode('template'), class: 'btn-secondary', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>' }
            ];
            
            addButtons(buttons);
        }

        function selectMode(mode) {
            STATE.mode = mode;
            addMessage(`–í—ã –≤—ã–±—Ä–∞–ª–∏: ${MODES[mode].name}`, true);
            
            if (mode === 'template') {
                showTemplateMode();
            } else {
                askContactInfo();
            }
        }

        function askContactInfo() {
            if (STATE.contactInfoSaved && STATE.contactInfo.name) {
                setTimeout(() => {
                    addMessage(`–Ø –ø–æ–º–Ω—é –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ: ${STATE.contactInfo.name} (${STATE.contactInfo.contact}). –ü—Ä–æ–¥–æ–ª–∂–∏–º —Å —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π?`, false);
                    const buttons = [
                        { text: '–î–∞, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å', action: () => { addMessage('–î–∞, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å', true); setTimeout(() => startQuestionnaire(), 500); }, class: 'btn-primary' },
                        { text: '–ù–µ—Ç, –∏–∑–º–µ–Ω–∏—Ç—å', action: () => { addMessage('–ù–µ—Ç, –∏–∑–º–µ–Ω–∏—Ç—å', true); STATE.contactInfoSaved = false; setTimeout(() => askContactInfo(), 500); }, class: 'btn-secondary' }
                    ];
                    addButtons(buttons);
                }, 500);
                return;
            }
            
            setTimeout(() => {
                addMessage('–û—Ç–ª–∏—á–Ω–æ! –î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º —Å –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.', false);
                setTimeout(() => {
                    addMessage('–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?', false, true);
                    STATE.currentQuestion = '–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?';
                    enableInput('name');
                }, 500);
            }, 500);
        }

        function enableInput(field) {
            const input = document.getElementById('userInput');
            input.disabled = false;
            input.focus();
            input.dataset.field = field;
        }

        function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message) return;
            input.value = '';
            // Validate input for text fields
            const field = input.dataset.field;
            const textFields = ['name', 'contact', 'organization', 'custom', 'edit', 'budget'];
            
            if (textFields.includes(field)) {
                const validationResult = validateInput(message, field);
                if (!validationResult.valid) {
                    showError(validationResult.message);
                    return;
                }
            }
            
            addMessage(message, true);
            input.value = '';
            input.disabled = true;
            
            handleUserResponse(field, message);
        }

        function validateInput(text, field) {
            // Name field validation
            if (field === 'name') {
                // Minimum 2 characters
                if (text.length < 2) {
                    return { valid: false, message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è (–º–∏–Ω–∏–º—É–º 2 –±—É–∫–≤—ã)' };
                }
                
                // Must have at least letters
                const hasLetters = /[a-zA-Z–∞-—è–ê-–Ø—ë–Å]/.test(text);
                if (!hasLetters) {
                    return { valid: false, message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è (–º–∏–Ω–∏–º—É–º 2 –±—É–∫–≤—ã)' };
                }
                
                // Check for obvious nonsense patterns
                const textClean = text.replace(/\s/g, '').toLowerCase();
                
                // Known nonsense keyboard smashing
                const knownNonsense = ['—à—â–æ–≤–∞–ø', '—Ñ—ã—ã–≤–∞–ø', 'aaaaaaa', 'zzzzzzz', 'qwerty', 'asdfgh', '—Ñ—ã–≤–∞–ø—Ä'];
                if (knownNonsense.some(ns => textClean.includes(ns))) {
                    return { valid: false, message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è (–º–∏–Ω–∏–º—É–º 2 –±—É–∫–≤—ã)' };
                }
                
                // Same character repeated more than 3 times
                if (/(.)\1{3,}/.test(textClean)) {
                    return { valid: false, message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è (–º–∏–Ω–∏–º—É–º 2 –±—É–∫–≤—ã)' };
                }
                
                // Only symbols/numbers
                if (/^[^a-zA-Z–∞-—è–ê-–Ø—ë–Å]+$/.test(text)) {
                    return { valid: false, message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è (–º–∏–Ω–∏–º—É–º 2 –±—É–∫–≤—ã)' };
                }
                
                return { valid: true };
            }
            
            // Contact field validation - recognize social media tags
            if (field === 'contact') {
                // Check if it's a social media tag (starts with @)
                if (text.startsWith('@') && text.length > 1 && !text.includes(' ')) {
                    // Valid social media tag
                    return { valid: true };
                }
                
                const hasAtSymbol = text.includes('@');
                if (hasAtSymbol && !text.startsWith('@')) {
                    // This looks like an email, validate it
                    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailPattern.test(text)) {
                        return { valid: false, message: '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email (–ø—Ä–∏–º–µ—Ä: name@example.com)' };
                    }
                }
                return { valid: true };
            }
            
            // Budget validation - FLEXIBLE for all formats
            if (field === 'budget') {
                // Allow "–Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω", "–Ω–µ —É–∫–∞–∑–∞–Ω", etc.
                const unlimitedPatterns = /–Ω–µ\s*(–æ–≥—Ä–∞–Ω–∏—á–µ–Ω|—É–∫–∞–∑–∞–Ω|–≤–∞–∂–Ω–æ)|–¥–æ–≥–æ–≤–æ—Ä|–æ–±—Å—É–∂–¥–∞–µ/i;
                if (unlimitedPatterns.test(text)) {
                    return { valid: true };
                }

                // Accept ANY input with at least one digit (60000, 60k, 60,000, 60000 —Ä—É–±, –æ—Ç 60000, etc.)
                const hasDigits = /\d/.test(text);
                if (hasDigits) {
                    return { valid: true };
                }

                // Accept longer text descriptions (–¥–∞–∂–µ –±–µ–∑ —Ü–∏—Ñ—Ä, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç —Ä–∞–∑—É–º–Ω—ã–π)
                if (text.length >= 5) {
                    return { valid: true };
                }

                // If no digits and short text, it's invalid
                return { valid: false, message: '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –±—é–¥–∂–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: 60000, 60000 —Ä—É–±, 60k, –∏–ª–∏ "–Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω")' };
            }
            
            // General text validation for other fields
            // Minimum 2 characters (was 3, now more lenient)
            if (text.length < 2) {
                return { valid: false, message: '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç' };
            }
            
            // Must have letters or numbers
            const hasLettersOrNumbers = /[a-zA-Z–ê-–Ø–∞-—è–Å—ë0-9]/.test(text);
            if (!hasLettersOrNumbers) {
                return { valid: false, message: '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç' };
            }
            
            // Only spaces
            if (text.replace(/\s/g, '') === '') {
                return { valid: false, message: '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç' };
            }
            
            const textClean = text.replace(/\s/g, '').toLowerCase();
            
            // Known nonsense patterns
            const knownNonsense = ['—à—â–æ–≤–∞–ø', '—Ñ—ã—ã–≤–∞–ø', 'aaaaaaa', 'zzzzzzz', 'qwerty', 'asdfgh', '—Ñ—ã–≤–∞–ø—Ä'];
            if (knownNonsense.some(ns => textClean.includes(ns))) {
                return { valid: false, message: '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç' };
            }
            
            // Same character repeated more than 3 times
            if (/(.)\1{3,}/.test(textClean)) {
                return { valid: false, message: '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç' };
            }
            
            // Only special characters
            if (/^[^a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9]+$/.test(text)) {
                return { valid: false, message: '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç' };
            }
            
            return { valid: true };
        }

        function showError(message) {
            const chatContainer = document.getElementById('chatContainer');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>${message}`;
            chatContainer.appendChild(errorDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function handleUserResponse(field, message) {
            // Handle AI question answers
            if (field === 'ai-question') {
                const currentQ = STATE.aiQuestions[STATE.aiCurrentQuestionIndex];
                const questionText = typeof currentQ === 'string' ? currentQ : currentQ.q;
                STATE.aiAnswers[questionText] = message;
                STATE.aiCurrentQuestionIndex++;
                
                setTimeout(() => askNextAIQuestion(), 500);
                return;
            }
            
            // Check if current question has special field type
            const questions = getQuestionsForMode(STATE.mode);
            const currentQ = questions.find(q => (q.key || q.text) === STATE.currentQuestion);
            const fieldType = currentQ && currentQ.fieldType ? currentQ.fieldType : field;
            
            const validationResult = validateInput(message, fieldType);
            if (!validationResult.valid) {
                showError(validationResult.message);
                enableInput(field);
                return;
            }
            if (field === 'name') {
                STATE.contactInfo.name = message;
                setTimeout(() => {
                    addMessage('–ö–∞–∫ —Å –≤–∞–º–∏ —Å–≤—è–∑–∞—Ç—å—Å—è? (email, —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ —Å–æ—Ü—Å–µ—Ç–∏)', false, true);
                    STATE.currentQuestion = '–ö–∞–∫ —Å –≤–∞–º–∏ —Å–≤—è–∑–∞—Ç—å—Å—è?';
                    enableInput('contact');
                }, 500);
            } else if (field === 'contact') {
                STATE.contactInfo.contact = message;
                STATE.contactInfoSaved = true;
                setTimeout(() => {
                    startQuestionnaire();
                }, 500);
            } else if (field === 'organization') {
                STATE.contactInfo.organization = message;
                setTimeout(() => {
                    startQuestionnaire();
                }, 500);
            } else if (field === 'custom' || field === 'budget') {
                const questions = getQuestionsForMode(STATE.mode);
                const currentQ = questions[STATE.questionIndex];
                const key = currentQ ? (currentQ.key || currentQ.text) : STATE.currentQuestion;
                
                // Detect social media from user input
                if (key === 'q1_projectType' && detectSocialMedia(message)) {
                    STATE.detectedSocialMedia = true;
                }
                
                STATE.answers[key] = message;
                STATE.questionIndex++;
                setTimeout(() => {
                    askNextQuestion();
                }, 500);
            } else if (field === 'edit') {
                // Handle edit mode
                const key = STATE.currentQuestion;
                STATE.answers[key] = message;
                setTimeout(() => {
                    finishQuestionnaire();
                }, 500);
            }
        }

        function detectSocialMedia(text) {
            const lowerText = text.toLowerCase();
            const socialKeywords = [
                '–∞–≤–∞—Ç–∞—Ä–∫–∞ –¥–ª—è —Ç–≥', '–∞–≤–∞—Ç–∞—Ä–∫–∞ telegram', '–∞–≤–∞—Ç–∞—Ä–∫–∞ –¥–ª—è —Ç–µ–ª–µ–≥—Ä–∞–º', '–∞–≤–∞ –¥–ª—è —Ç–µ–ª–µ–≥—Ä–∞–º', '–∞–≤–∫–∞ –¥–ª—è —Ç–µ–ª–µ–≥—Ä–∞–º', '–∞–≤–∫–∞ –¥–ª—è —Ç–≥', '–∞–≤–∞', '–∞–≤–∞ –¥–ª—è —é—Ç',
                '—à–∞–ø–∫–∞ –¥–ª—è –≤–∫', '—à–∞–ø–∫–∞ vk', '–æ–±–ª–æ–∂–∫–∞ –≤–∫–æ–Ω—Ç–∞–∫—Ç–µ',
                '–∞–≤–∞—Ç–∞—Ä–∫–∞ youtube', '–∞–≤–∞—Ç–∞—Ä–∫–∞ –¥–ª—è —é—Ç—É–±', '–∞–≤–∞—Ç–∞—Ä–∫–∞ —é—Ç—É–±',
                '–∏–Ω—Å—Ç–∞–≥—Ä–∞–º', 'instagram', '–∏–Ω—Å—Ç–∞', '—Ä–∏–ª—Å', 'reels', '—Å—Ç–æ—Ä–∏—Å',
                '–¥–ª—è tiktok', '–¥–ª—è —Ç–∏–∫—Ç–æ–∫', '–¥–ª—è —Ç—Ç',
                '—Å–æ—Ü —Å–µ—Ç', '—Å–æ—Ü–∏–∞–ª—å–Ω',
                'avatar for', 'cover for', 'profile picture',
                '—Å–æ—Ü —Å–µ—Ç—å', '—Å–æ—Ü–∏–∞–ª—å–Ω–∞—è', '—Å–æ—Ü—Å–µ—Ç—å', '–±–∞–Ω–Ω–µ—Ä', '–ø–æ—Å—Ç–µ—Ä', '–ø–æ—Å—Ç'
            ];
            
            return socialKeywords.some(keyword => lowerText.includes(keyword));
        }
        
        async function startQuestionnaire() {
            addMessage('–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ –æ–±—Å—É–¥–∏–º –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞.', false);
            
            setTimeout(() => {
                askNextQuestion();
            }, 500);
        }

        async function askNextQuestion() {
            const questions = getQuestionsForMode(STATE.mode);
            
            if (STATE.questionIndex >= questions.length) {
                finishQuestionnaire();
                return;
            }
            
            const question = questions[STATE.questionIndex];
            const questionKey = question.key || question.text;
            
            // Smart skip logic for irrelevant questions
            if (shouldSkipQuestion(question, questionKey)) {
                STATE.questionIndex++;
                setTimeout(() => askNextQuestion(), 100);
                return;
            }
            
            if (STATE.askedQuestions.has(questionKey) && !STATE.isEditing) {
                STATE.questionIndex++;
                setTimeout(() => askNextQuestion(), 100);
                return;
            }
            
            STATE.askedQuestions.add(questionKey);
            STATE.currentQuestion = questionKey;
            STATE.isEditing = false;
            
            // Check for social media context and auto-confirm
            if (questionKey === 'q1b_materials' && STATE.detectedSocialMedia) {
                addMessage('–Ø –≤–∏–∂—É, —á—Ç–æ —ç—Ç–æ –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π. –í–µ—Ä–Ω–æ?', false);
                const buttons = [
                    { text: '–î–∞', action: () => { addMessage('–î–∞', true); STATE.answers[questionKey] = '–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏'; STATE.questionIndex++; setTimeout(() => askNextQuestion(), 500); }, class: 'btn-primary' },
                    { text: '–ù–µ—Ç, —É—Ç–æ—á–Ω–∏—Ç—å', action: () => { addMessage('–ù–µ—Ç, —É—Ç–æ—á–Ω–∏—Ç—å', true); STATE.detectedSocialMedia = false; setTimeout(() => askRegularQuestion(question, questionKey), 500); }, class: 'btn-secondary' }
                ];
                addButtons(buttons);
                return;
            }
            
            askRegularQuestion(question, questionKey);
        }
        
        function shouldSkipQuestion(question, questionKey) {
            // Skip print-related questions for web design
            if (STATE.mode === 'web') {
                // –í–ê–ñ–ù–û: –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–∏ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –≤–µ–±-–¥–∏–∑–∞–π–Ω–∞
                if (questionKey === 'q1_projectType' || questionKey === 'q1b_materials') {
                    return true;
                }

                if (questionKey === 'q1d_quantity' || questionKey === 'qpoly1_printtech' || 
                    questionKey === 'qpoly2_format' || questionKey === 'qpoly3_material' || 
                    questionKey === 'qpoly4_folding' || questionKey === 'qpoly5_finishing') {
                    return true;
                }

                // Skip size question with A4 reference for web
                if (questionKey === 'q1c_sizes') {
                    return true;
                }

                // Skip platform question if website type is specified
                if (questionKey === 'q1e_platform' && STATE.answers['q4_websiteType']) {
                    return true;
                }
            }

            // Skip materials/platform questions if social media detected
            if (STATE.detectedSocialMedia && (questionKey === 'q1e_platform')) {
                STATE.answers[questionKey] = '–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏';
                return true;
            }

            return false;
        }
        
        function askRegularQuestion(question, questionKey) {
            // Get theme-based hint
            const hint = getThemeBasedHint(question, STATE.mode);
            addMessage(question.text, false, question.hasDetail || false, hint);
            
            if (question.type === 'buttons') {
                let buttons = question.options.map(opt => ({
                    text: opt.text,
                    action: () => selectOption(questionKey, opt.value, opt.text),
                    class: 'btn-secondary'
                }));
                
                // Add "Other" option if specified
                if (question.allowOther) {
                    buttons.push({
                        text: '–î—Ä—É–≥–æ–µ',
                        action: () => showOtherInput(questionKey),
                        class: 'btn-secondary'
                    });
                }
                
                addButtons(buttons);
            } else if (question.type === 'colors') {
                showColorPalettes();
            } else if (question.type === 'style') {
                showStyles();
            } else if (question.type === 'file') {
                showFileUpload(questionKey);
            } else {
                const fieldToUse = question.fieldType || 'custom';
                enableInput(fieldToUse);
            }
        }
        
        function showOtherInput(questionKey) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞
            addMessage('–í–≤–µ–¥–∏—Ç–µ —á—Ç–æ –≤—ã –∏–º–µ–µ—Ç–µ –≤ –≤–∏–¥—É:', false);

            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            setTimeout(() => {
                enableInput('custom');
            }, 300);
        }


        
        function selectOption(key, value, text) {
            console.log('selectOption called:', { key, value, text, currentIndex: STATE.questionIndex });
            STATE.answers[key] = value;
            addMessage(text, true);
            
            // Detect social media from project type
            if (key === 'q1_projectType' && detectSocialMedia(value)) {
                STATE.detectedSocialMedia = true;
            }
            
            STATE.questionIndex++;
            
            setTimeout(() => {
                console.log('Moving to next question, index:', STATE.questionIndex);
                askNextQuestion();
            }, 500);
        }

        function showColorPalettes() {
            const chatContainer = document.getElementById('chatContainer');
            const lastMessage = chatContainer.lastElementChild;
            const contentDiv = lastMessage.querySelector('.message-content');
            
            const paletteDiv = document.createElement('div');
            paletteDiv.className = 'color-palette-grid';
            
            const shuffledPalettes = shuffleArray(COLOR_PALETTES).slice(0, 5);
            
            shuffledPalettes.forEach((palette, index) => {
                const item = document.createElement('div');
                item.className = 'color-palette-item';
                item.dataset.paletteName = palette.name;
                item.onclick = () => selectColorPalette(palette, item);
                
                const name = document.createElement('div');
                name.className = 'color-palette-name';
                name.textContent = palette.name;
                
                const colorsDiv = document.createElement('div');
                colorsDiv.className = 'color-palette-colors';
                
                palette.colors.forEach(color => {
                    const swatch = document.createElement('div');
                    swatch.className = 'color-palette-swatch';
                    swatch.style.backgroundColor = color;
                    colorsDiv.appendChild(swatch);
                });
                
                item.appendChild(name);
                item.appendChild(colorsDiv);
                paletteDiv.appendChild(item);
            });
            
            contentDiv.appendChild(paletteDiv);
            
            const selectedSection = document.createElement('div');
            selectedSection.className = 'selected-colors-list';
            selectedSection.innerHTML = `
                <h4>–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞:</h4>
                <div id="selectedColorsGrid" class="selected-colors-grid"></div>
            `;
            contentDiv.appendChild(selectedSection);
            
            const customSection = document.createElement('div');
            customSection.className = 'custom-colors-section';
            customSection.innerHTML = `
                <p style="margin: var(--space-16) 0 var(--space-8) 0; color: #b0b0b0;">–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏ —Ü–≤–µ—Ç–∞:</p>
                <div class="color-picker-container" style="display: flex; gap: var(--space-8); align-items: center;">
                    <div style="display: flex; align-items: center; gap: var(--space-8); padding: var(--space-12); background: #1f1f1f; border-radius: var(--radius-base); border: 1px solid #404040;">
                        <div style="width: 50px; height: 50px; border-radius: var(--radius-sm); border: 2px solid #404040; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                            <input type="color" id="customColorPicker" value="#2A9A9F" style="width: 60px; height: 60px; margin: -5px; border: none; cursor: pointer; background: transparent;">
                        </div>
                        <span style="color: #b0b0b0; font-size: 14px; font-weight: 500;">–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç</span>
                    </div>
                    <button class="btn-add-color" onclick="addCustomColor()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        –î–æ–±–∞–≤–∏—Ç—å —Ü–≤–µ—Ç
                    </button>
                </div>
            `;
            contentDiv.appendChild(customSection);
            
            const doneBtn = document.createElement('button');
            doneBtn.className = 'btn btn-primary';
            doneBtn.textContent = '–ì–æ—Ç–æ–≤–æ';
            doneBtn.style.marginTop = 'var(--space-16)';
            doneBtn.onclick = () => finishColorSelection();
            contentDiv.appendChild(doneBtn);
            
            setTimeout(() => displaySelectedColors(), 100);
        }

        function selectColorPalette(palette, element) {
            // Mark as selected
            element.classList.add('selected');
            
            // Add all colors from palette to selected colors
            palette.colors.forEach(color => {
                if (!STATE.selectedColors.includes(color.toUpperCase())) {
                    STATE.selectedColors.push(color.toUpperCase());
                }
            });
            
            displaySelectedColors();
        }

        function addCustomColor() {
            const picker = document.getElementById('customColorPicker');
            const color = picker.value.toUpperCase();
            
            if (!STATE.selectedColors.includes(color)) {
                STATE.selectedColors.push(color);
                displaySelectedColors();
            }
        }

        function displaySelectedColors() {
            const grid = document.getElementById('selectedColorsGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            if (STATE.selectedColors.length === 0) {
                grid.innerHTML = '<p style="color: #b0b0b0; font-size: 12px;">–¶–≤–µ—Ç–∞ –µ—â–µ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</p>';
                return;
            }
            
            STATE.selectedColors.forEach((color, index) => {
                const item = document.createElement('div');
                item.className = 'selected-color-item';
                item.innerHTML = `
                    <div class="selected-color-swatch" style="background-color: ${color};"></div>
                    <span class="selected-color-hex">${color}</span>
                    <button class="btn-remove-selected-color" onclick="removeSelectedColor(${index})">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                `;
                grid.appendChild(item);
            });
        }

        function removeSelectedColor(index) {
            STATE.selectedColors.splice(index, 1);
            displaySelectedColors();
        }

        function finishColorSelection() {
            if (STATE.selectedColors.length === 0) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ü–≤–µ—Ç');
                return;
            }
            
            const colorText = `–í—ã–±—Ä–∞–Ω–æ ${STATE.selectedColors.length} ${STATE.selectedColors.length === 1 ? '—Ü–≤–µ—Ç' : '—Ü–≤–µ—Ç–∞/—Ü–≤–µ—Ç–æ–≤'}`;
            
            addMessage(colorText, true);
            
            const questions = getQuestionsForMode(STATE.mode);
            const currentQ = questions[STATE.questionIndex];
            const key = currentQ ? (currentQ.key || currentQ.text) : 'colors';
            
            STATE.answers[key] = STATE.selectedColors.join(', ');
            
            if (STATE.isEditing) {
                STATE.isEditing = false;
                setTimeout(() => showSummary(), 500);
            } else {
                STATE.questionIndex++;
                setTimeout(() => askNextQuestion(), 500);
            }
        }



        function showStyles() {
            let availableStyles = Object.keys(STYLES);
            
            const buttons = availableStyles.map(key => ({
                text: STYLES[key],
                action: () => selectStyle(key, STYLES[key]),
                class: 'btn-secondary'
            }));
            
            buttons.push({
                text: '–î—Ä—É–≥–æ–µ',
                action: () => showOtherInput('q6_style'),
                class: 'btn-secondary'
            });
            
            // Add skip button
            buttons.push({
                text: '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å',
                action: () => skipStyleQuestion(),
                class: 'btn-secondary'
            });
            
            addButtons(buttons);
        }
        
        function skipStyleQuestion() {
            const questions = getQuestionsForMode(STATE.mode);
            const currentQ = questions[STATE.questionIndex];
            const key = currentQ ? (currentQ.key || currentQ.text) : 'style';
            
            STATE.answers[key] = 'skipped';
            addMessage('–ü—Ä–æ–ø—É—â–µ–Ω–æ', true);
            
            if (STATE.isEditing) {
                STATE.isEditing = false;
                setTimeout(() => showSummary(), 500);
            } else {
                STATE.questionIndex++;
                setTimeout(() => askNextQuestion(), 500);
            }
        }

        function showOtherStyleInput() {
            const chatContainer = document.getElementById('chatContainer');
            const lastMessage = chatContainer.lastElementChild;
            const actionsDiv = lastMessage.querySelector('.message-actions');
            
            if (!actionsDiv) return;
            
            const otherBtn = Array.from(actionsDiv.querySelectorAll('button')).find(btn => btn.textContent.includes('–î—Ä—É–≥–æ–µ'));
            if (otherBtn) {
                const container = document.createElement('div');
                container.className = 'other-input-container';
                container.innerHTML = `
                    <input type="text" id="otherStyleInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∏–ª—å..." style="min-width: 200px;">
                    <button class="btn-add-other" onclick="addOtherStyle()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                `;
                otherBtn.replaceWith(container);
                const input = document.getElementById('otherStyleInput');
                input.focus();
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addOtherStyle();
                    }
                });
            }
        }

        function addOtherStyle() {
            const input = document.getElementById('otherStyleInput');
            const value = input.value.trim();
            
            if (!value) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å—Ç–∏–ª—å');
                return;
            }
            
            const validationResult = validateInput(value);
            if (!validationResult.valid) {
                showError(validationResult.message);
                return;
            }
            
            selectStyle('custom', value);
        }

        function selectStyle(style, displayText) {
            const questions = getQuestionsForMode(STATE.mode);
            const currentQ = questions[STATE.questionIndex];
            const key = currentQ ? (currentQ.key || currentQ.text) : 'style';
            
            STATE.answers[key] = displayText || STYLES[style] || style;
            addMessage(`–í—ã–±—Ä–∞–Ω —Å—Ç–∏–ª—å: ${displayText || STYLES[style] || style}`, true);
            
            if (STATE.isEditing) {
                STATE.isEditing = false;
                setTimeout(() => showSummary(), 500);
            } else {
                STATE.questionIndex++;
                setTimeout(() => askNextQuestion(), 500);
            }
        }

        function showFileUpload(key) {
            const chatContainer = document.getElementById('chatContainer');
            const lastMessage = chatContainer.lastElementChild;
            const contentDiv = lastMessage.querySelector('.message-content');
            
            const tabsContainer = document.createElement('div');
            tabsContainer.innerHTML = `
                <div class="tabs-container">
                    <button class="tab-button active" onclick="switchTab('images')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    </button>
                    <button class="tab-button" onclick="switchTab('links')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                        </svg>
                        –°—Å—ã–ª–∫–∏
                    </button>
                </div>
                <div id="imagesTab" class="tab-content active">
                    <div class="file-input-wrapper" style="margin-top: var(--space-12);">
                        <input type="file" accept="image/*" multiple id="file-${key}">
                        <button class="btn btn-secondary" onclick="document.getElementById('file-${key}').click()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        </button>
                    </div>
                    <div id="uploadedImagesCount"></div>
                </div>
                <div id="linksTab" class="tab-content">
                    <div class="link-input-container" style="margin-top: var(--space-12);">
                        <input type="text" id="linkInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É...">
                        <button class="btn btn-primary" onclick="addLink('${key}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                            </svg>
                            –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                    </div>
                    <div id="linksList" class="links-list"></div>
                </div>
            `;
            contentDiv.appendChild(tabsContainer);
            
            document.getElementById(`file-${key}`).onchange = (e) => handleFileUpload(e, key);
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions';
            actionsDiv.style.marginTop = 'var(--space-16)';
            actionsDiv.innerHTML = `
                <button class="btn btn-primary" onclick="finishFileUpload('${key}')">–ì–æ—Ç–æ–≤–æ</button>
                <button class="btn btn-secondary" onclick="skipQuestion('${key}')">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
            `;
            contentDiv.appendChild(actionsDiv);
            
            displayUploadedContent();
        }

        function switchTab(tabName) {
            const buttons = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');
            
            buttons.forEach(btn => btn.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function addLink(key) {
            const input = document.getElementById('linkInput');
            const url = input.value.trim();
            
            if (!url) return;
            
            if (!STATE.uploadedLinks) STATE.uploadedLinks = [];
            STATE.uploadedLinks.push(url);
            input.value = '';
            displayUploadedContent();
        }

        function removeLink(index) {
            STATE.uploadedLinks.splice(index, 1);
            displayUploadedContent();
        }

        function displayUploadedContent() {
            const imagesCount = document.getElementById('uploadedImagesCount');
            if (imagesCount && STATE.uploadedFiles) {
                if (STATE.uploadedFiles.length > 0) {
                    imagesCount.innerHTML = `<p style="margin-top: var(--space-8); color: #2A9A9F; font-weight: 500;">–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${STATE.uploadedFiles.length} —Ñ–∞–π–ª(–æ–≤)</p>`;
                    displayUploadedImages();
                } else {
                    imagesCount.innerHTML = '';
                }
            }
            
            const linksList = document.getElementById('linksList');
            if (linksList && STATE.uploadedLinks) {
                linksList.innerHTML = '';
                STATE.uploadedLinks.forEach((link, index) => {
                    const item = document.createElement('div');
                    item.className = 'link-item';
                    item.innerHTML = `
                        <a href="${link}" target="_blank">${link}</a>
                        <button class="btn-remove-link" onclick="removeLink(${index})">√ó</button>
                    `;
                    linksList.appendChild(item);
                });
            }
        }

        function handleFileUpload(event, key) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            STATE.uploadedImages = STATE.uploadedImages || [];
            STATE.uploadedFiles = STATE.uploadedFiles || [];
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    STATE.uploadedImages.push(e.target.result);
                    STATE.uploadedFiles.push({ name: file.name, data: e.target.result });
                    displayUploadedImages();
                    displayUploadedContent();
                };
                reader.readAsDataURL(file);
            });
        }

        function displayUploadedImages() {
            const imagesTab = document.getElementById('imagesTab');
            if (!imagesTab) return;
            
            let imagesContainer = imagesTab.querySelector('.uploaded-images-container');
            if (!imagesContainer) {
                imagesContainer = document.createElement('div');
                imagesContainer.className = 'uploaded-images-container';
                imagesContainer.style.marginTop = 'var(--space-12)';
                imagesContainer.style.display = 'flex';
                imagesContainer.style.flexWrap = 'wrap';
                imagesContainer.style.gap = 'var(--space-8)';
                const fileInput = imagesTab.querySelector('.file-input-wrapper');
                if (fileInput) {
                    fileInput.after(imagesContainer);
                }
            }
            
            imagesContainer.innerHTML = '';
            
            if (STATE.uploadedFiles && STATE.uploadedFiles.length > 0) {
                STATE.uploadedFiles.forEach((file, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'uploaded-image-item';
                    itemDiv.innerHTML = `
                        <img src="${file.data}" alt="${file.name}">
                        <button class="btn-remove-image" onclick="removeUploadedImage(${index})">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    `;
                    imagesContainer.appendChild(itemDiv);
                });
            }
        }

        function removeUploadedImage(index) {
            STATE.uploadedFiles.splice(index, 1);
            STATE.uploadedImages.splice(index, 1);
            displayUploadedImages();
            displayUploadedContent();
        }
        
        function finishFileUpload(key) {
            const filesCount = (STATE.uploadedFiles || []).length;
            const linksCount = (STATE.uploadedLinks || []).length;
            
            let message = '';
            if (filesCount > 0 && linksCount > 0) {
                message = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${filesCount} —Ñ–∞–π–ª–æ–≤ –∏ ${linksCount} —Å—Å—ã–ª–æ–∫`;
            } else if (filesCount > 0) {
                message = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${filesCount} —Ñ–∞–π–ª–æ–≤`;
            } else if (linksCount > 0) {
                message = `–î–æ–±–∞–≤–ª–µ–Ω–æ ${linksCount} —Å—Å—ã–ª–æ–∫`;
            } else {
                message = '–ü—Ä–æ–ø—É—â–µ–Ω–æ';
            }
            
            STATE.answers[key] = message;
            addMessage('–ì–æ—Ç–æ–≤–æ', true);
            STATE.questionIndex++;
            
            setTimeout(() => {
                askNextQuestion();
            }, 500);
        }

        function skipQuestion(key) {
            STATE.answers[key] = 'skipped';
            addMessage('–ü—Ä–æ–ø—É—â–µ–Ω–æ', true);
            STATE.questionIndex++;
            
            setTimeout(() => {
                askNextQuestion();
            }, 500);
        }

        function finishQuestionnaire() {
            showSummary();
        }
        
        function showSummary() {
            addMessage('–û—Ç–ª–∏—á–Ω–æ! –ú—ã —Å–æ–±—Ä–∞–ª–∏ –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –í–æ—Ç —Å–≤–æ–¥–∫–∞:', false);
            
            const summaryHTML = generateSummaryHTML();
            addMessage(summaryHTML, false);
            
            const buttons = [
                { text: '–ì–æ—Ç–æ–≤–æ, —Å–∫–∞—á–∞—Ç—å –¢–ó –≤ PDF', action: () => generateDocument(), class: 'btn-primary', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>' },
                { text: '–î–æ–ø–æ–ª–Ω–∏—Ç—å —Å AI', action: () => enhanceWithAI(), class: 'btn-primary', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>' },
                { text: '–ò–∑–º–µ–Ω–∏—Ç—å', action: () => showEditOptions(), class: 'btn-secondary', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>' }
            ];
            
            addButtons(buttons);
        }

        async function enhanceWithAI() {
            addMessage('–î–æ–ø–æ–ª–Ω–∏—Ç—å —Å AI', true);
            addMessage('–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –ø–æ–ª–Ω–æ—Ç—É –¢–ó –∏ –æ–ø—Ä–µ–¥–µ–ª—è—é –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —É—Ç–æ—á–Ω–µ–Ω–∏–π...', false);
            addTypingIndicator();
            
            const projectContext = extractFullProjectContext();
            const filledAnswers = Object.keys(STATE.answers).filter(k => 
                STATE.answers[k] !== 'skipped' && STATE.answers[k] !== '' && STATE.answers[k]
            );
            const completeness = calculateCompletenessScore();

            // –í–∞–∂–Ω–æ: –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–∫–ª—é—á–∞–µ—Ç –í–°–ï –æ—Ç–≤–µ—Ç—ã, –Ω–µ —Ç–æ–ª—å–∫–æ 3 –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
            const allAnswers = Object.entries(STATE.answers)
                .filter(([k, v]) => v !== 'skipped' && v !== '')
                .map(([k, v]) => `${k}: ${v}`)
                .join('\n');

            const prompt = `–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –≤ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞–Ω–∏–π –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–æ–≤.

        –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–†–û–ï–ö–¢–ï (—Ç–æ, —á—Ç–æ —É–∂–µ –∑–Ω–∞–µ—Ç –∑–∞–∫–∞–∑—á–∏–∫):
        ${allAnswers}

        –ó–ê–î–ê–ß–ê: –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å—ã –î–õ–Ø –ó–ê–ö–ê–ó–ß–ò–ö–ê (–ø—Ä–æ—Å—Ç—ã–µ, –ø–æ–Ω—è—Ç–Ω—ã–µ, –Ω–µ –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞), –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞—Å–∫—Ä–æ—é—Ç –¢–ó –ø–æ–ª–Ω–æ—Å—Ç—å—é.

        –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
        - –í–æ–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω—ã –ü–†–û–°–¢–´–ú —è–∑—ã–∫–æ–º –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –ù–ï —Ä–∞–∑–±–∏—Ä–∞–µ—Ç—Å—è –≤ –¥–∏–∑–∞–π–Ω–µ
        - –ù–ï —Å–ø—Ä–∞—à–∏–≤–∞–π –æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –¥–µ—Ç–∞–ª—è—Ö: —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–µ, –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏, –ø–∞—Ç—Ç–µ—Ä–Ω–∞—Ö - —ç—Ç–æ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞, –∞ –Ω–µ –∫–ª–∏–µ–Ω—Ç–∞
        - –í–æ–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å –ë–ò–ó–ù–ï–°-–¶–ï–õ–ò, –æ—â—É—â–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –∞—É–¥–∏—Ç–æ—Ä–∏—é, –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        - –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –í–°–ï —ç—Ç–∏ –≤–æ–ø—Ä–æ—Å—ã –¥–∏–∑–∞–π–Ω–µ—Ä –¥–æ–ª–∂–µ–Ω –ü–û–õ–ù–û–°–¢–¨–Æ –ø–æ–Ω—è—Ç—å –∑–∞–¥–∞—á—É –ë–ï–ó –î–û–ü. –£–¢–û–ß–ù–ï–ù–ò–ô
        - –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –≤–æ–ø—Ä–æ—Å—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –ø–æ–ª—É—á–µ–Ω—ã –æ—Ç–≤–µ—Ç—ã –≤—ã—à–µ
        - –£—á–∏—Ç—ã–≤–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —á–∞—Ç–∞ –∏ –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–π –æ—á–µ–≤–∏–¥–Ω–æ–µ

        –ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–´–• –í–û–ü–†–û–°–û–í (–¥–ª—è –∑–∞–∫–∞–∑—á–∏–∫–∞):
        - "–ö—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –±—É–¥–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —ç—Ç–∏–º –¥–∏–∑–∞–π–Ω–æ–º?" (–≤–º–µ—Å—Ç–æ "–ö–∞–∫–∞—è —Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è")
        - "–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞? –ö–∞–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã –æ–∂–∏–¥–∞–µ—Ç–µ?" (–≤–º–µ—Å—Ç–æ "–ö–∞–∫–æ–π —É—Å–ø–µ—Ö –¥–∏–∑–∞–π–Ω–∞")
        - "–ï—Å—Ç—å –ª–∏ –∫–æ–º–ø–∞–Ω–∏–∏/—Å–∞–π—Ç—ã/–¥–∏–∑–∞–π–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –Ω—Ä–∞–≤—è—Ç—Å—è? –ü–æ–∫–∞–∂–∏—Ç–µ –ø—Ä–∏–º–µ—Ä—ã" (–≤–º–µ—Å—Ç–æ "–ö–∞–∫–∏–µ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã")
        - "–ö–æ–≥–¥–∞ –ª—é–¥–∏ –±—É–¥—É—Ç —ç—Ç–æ –≤–∏–¥–µ—Ç—å? –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ, –≤ –º–∞–≥–∞–∑–∏–Ω–µ, –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ?" (–≤–º–µ—Å—Ç–æ "–ù–∞ –∫–∞–∫–∏—Ö –Ω–æ—Å–∏—Ç–µ–ª—è—Ö")

        –ü–†–ò–ú–ï–†–´ –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–• –í–û–ü–†–û–°–û–í (–¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞, –ù–ï –∑–∞–¥–∞–≤–∞–π):
        - "–ö–∞–∫–∞—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞? –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è, –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∏–ª–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è?" - –≠–¢–û –ù–ï –°–ü–†–ê–®–ò–í–ê–ô
        - "–ö–∞–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ –∏–∫–æ–Ω–∫–∏ –Ω—É–∂–Ω—ã?" - –≠–¢–û –ù–ï –°–ü–†–ê–®–ò–í–ê–ô
        - "–ö–∞–∫–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è?" - –≠–¢–û –ù–ï –°–ü–†–ê–®–ò–í–ê–ô

        –û–ø—Ä–µ–¥–µ–ª–∏ —Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω—É–∂–Ω–æ (—É—á–∏—Ç—ã–≤–∞—è –ø–æ–ª–Ω–æ—Ç—É ${completeness}%):
        - –ï—Å–ª–∏ –ø–æ–ª–Ω–æ—Ç–∞ > 75% ‚Üí 4-5 –≤–æ–ø—Ä–æ—Å–æ–≤ (—É–∂–µ –ø–æ—á—Ç–∏ –≤—Å—ë –∏–∑–≤–µ—Å—Ç–Ω–æ)
        - –ï—Å–ª–∏ –ø–æ–ª–Ω–æ—Ç–∞ 50-75% ‚Üí 6-7 –≤–æ–ø—Ä–æ—Å–æ–≤ (–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏)
        - –ï—Å–ª–∏ –ø–æ–ª–Ω–æ—Ç–∞ < 50% ‚Üí 8-9 –≤–æ–ø—Ä–æ—Å–æ–≤ (–º–Ω–æ–≥–æ–µ –Ω–µ —è—Å–Ω–æ)

        –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –¢–û–õ–¨–ö–û JSON: 
        {
        "questions": [
            {"q": "–ü—Ä–æ—Å—Ç–æ–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –∑–∞–∫–∞–∑—á–∏–∫–∞?", "detail": "–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞: ..."},
            {"q": "–ï—â—ë –≤–æ–ø—Ä–æ—Å?", "detail": "–û–±—ä—è—Å–Ω–µ–Ω–∏–µ..."}
        ]
        }`;

            try {
                const response = await callGeminiAPI(prompt);
                removeTypingIndicator();

                let questions = [];
                try {
                    const jsonMatch = response.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const parsed = JSON.parse(jsonMatch[0]);
                        questions = parsed.questions || [];
                    }
                } catch (e) {
                    // Fallback –≤–æ–ø—Ä–æ—Å—ã - –£–ñ–ï –¥–ª—è –∑–∞–∫–∞–∑—á–∏–∫–∞
                    const count = completeness > 75 ? 5 : (completeness > 50 ? 7 : 9);
                    const allQuestions = [
                        {q: '–ö—Ç–æ –∏–º–µ–Ω–Ω–æ –±—É–¥–µ—Ç –≤–∏–¥–µ—Ç—å —ç—Ç–æ—Ç –¥–∏–∑–∞–π–Ω? –û–ø–∏—à–∏—Ç–µ –≤–∞—à—É —Ü–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é', detail: '–î–∏–∑–∞–π–Ω–µ—Ä—É –Ω—É–∂–Ω–æ –ø–æ–Ω—è—Ç—å, –¥–ª—è –∫–æ–≥–æ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∏–ª—å'},
                        {q: '–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –ª—é–¥–∏ —É–≤–∏–¥—è—Ç –¥–∏–∑–∞–π–Ω? –ö–∞–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã —Ö–æ—Ç–∏—Ç–µ?', detail: '–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –¥–∏–∑–∞–π–Ω–µ—Ä—É —Å–æ–∑–¥–∞—Ç—å –¥–∏–∑–∞–π–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–æ—Å—ã–ª–æ–º - –ø—Ä–∏–≤–ª–µ—á—å, —É–±–µ–¥–∏—Ç—å, –ø–æ–Ω—Ä–∞–≤–∏—Ç—å—Å—è'},
                        {q: '–ï—Å—Ç—å –ª–∏ –ø—Ä–∏–º–µ—Ä—ã (—Å—Å—ã–ª–∫–∏, —Ñ–æ—Ç–æ, —Å–∫—Ä–∏–Ω—à–æ—Ç—ã), –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –Ω—Ä–∞–≤—è—Ç—Å—è? –ß—Ç–æ –≤ –Ω–∏—Ö –≤–∞–º –Ω—Ä–∞–≤–∏—Ç—Å—è?', detail: '–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –ø–æ–º–æ–≥—É—Ç –¥–∏–∑–∞–π–Ω–µ—Ä—É –ø–æ–Ω—è—Ç—å –≤–∞—à—É —ç—Å—Ç–µ—Ç–∏–∫—É –ª—É—á—à–µ —Å–ª–æ–≤'},
                        {q: '–ö–æ–≥–¥–∞ –∏ –≥–¥–µ –ª—é–¥–∏ –±—É–¥—É—Ç —ç—Ç–æ –≤–∏–¥–µ—Ç—å? –ì–¥–µ –∏–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è?', detail: '–û—Ç —ç—Ç–æ–≥–æ –∑–∞–≤–∏—Å–∏—Ç, –∫–∞–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∏–∑–∞–π–Ω –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è'},
                        {q: '–ö–∞–∫–æ–µ –≥–ª–∞–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –∏–¥–µ—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –¥–∏–∑–∞–π–Ω–µ? –í –æ–¥–Ω–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏', detail: '–≠—Ç–æ –æ—Å–Ω–æ–≤–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –¥–∏–∑–∞–π–Ω–µ—Ä —Å—Ç—Ä–æ–∏—Ç –≤—Å—é –∫–æ–Ω—Ü–µ–ø—Ü–∏—é'},
                        {q: '–ß—Ç–æ –≤–∞—Å –æ—Ç–ª–∏—á–∞–µ—Ç –æ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤? –ü–æ—á–µ–º—É –ª—é–¥–∏ –¥–æ–ª–∂–Ω—ã –≤—ã–±—Ä–∞—Ç—å –∏–º–µ–Ω–Ω–æ –≤–∞—Å?', detail: '–î–∏–∑–∞–π–Ω–µ—Ä –¥–æ–ª–∂–µ–Ω –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—å –≤–∞—à—É —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –≤–∏–∑—É–∞–ª'},
                        {q: '–ö–∞–∫–æ–µ –æ—â—É—â–µ–Ω–∏–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å –¥–∏–∑–∞–π–Ω? –î–æ–≤–µ—Ä–∏–µ? –í–µ—Å–µ–ª—å–µ? –õ–µ–≥–∫–æ—Å—Ç—å? –°–æ–ª–∏–¥–Ω–æ—Å—Ç—å?', detail: '–û—Ç —ç–º–æ—Ü–∏–∏ –∑–∞–≤–∏—Å–∏—Ç –≤—ã–±–æ—Ä —Ü–≤–µ—Ç–æ–≤, —Ñ–æ—Ä–º, –∏ –æ–±—â–µ–π –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã'},
                        {q: '–ï—Å—Ç—å –ª–∏ —É–∂–µ –∫–∞–∫–∏–µ-—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è? –ë—é–¥–∂–µ—Ç, —Å—Ä–æ–∫–∏, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏?', detail: '–î–∏–∑–∞–π–Ω–µ—Ä—É –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–º–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞'},
                        {q: '–ö–∞–∫ –≤—ã –ø–æ–π–º—ë—Ç–µ, —á—Ç–æ –¥–∏–∑–∞–π–Ω —Ö–æ—Ä–æ—à–∏–π? –ü–æ –∫–∞–∫–∏–º –ø—Ä–∏–∑–Ω–∞–∫–∞–º –æ—Ü–µ–Ω–∏–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç?', detail: '–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ–º–æ–≥—É—Ç –¥–∏–∑–∞–π–Ω–µ—Ä—É –ø–æ–Ω—è—Ç—å –≤–∞—à—É –ø–ª–∞–Ω–∫—É'}
                    ];
                    questions = allQuestions.slice(0, count);
                }

                if (questions.length === 0 || questions.length < 4) {
                    questions = [
                        {q: '–ö—Ç–æ –≤–∞—à–∞ —Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è? –û–ø–∏—à–∏—Ç–µ –µ—ë', detail: '–ü–æ–º–æ–≥–∞–µ—Ç –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –∏ –ø–æ–¥—Ö–æ–¥'},
                        {q: '–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ–∏–∑–æ—à–ª–æ –ø–æ—Å–ª–µ? –ö–∞–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç?', detail: '–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ—Å—ã–ª –¥–∏–∑–∞–π–Ω–∞'},
                        {q: '–ï—Å—Ç—å –ª–∏ –ø—Ä–∏–º–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –Ω—Ä–∞–≤—è—Ç—Å—è?', detail: '–î–∞—ë—Ç –æ—Ä–∏–µ–Ω—Ç–∏—Ä –¥–ª—è —Å—Ç–∏–ª—è'},
                        {q: '–ì–¥–µ –∏ –∫–æ–≥–¥–∞ –ª—é–¥–∏ —ç—Ç–æ —É–≤–∏–¥—è—Ç?', detail: '–í–ª–∏—è–µ—Ç –Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –¥–∏–∑–∞–π–Ω–∞'},
                        {q: '–ö–∞–∫–æ–µ –≥–ª–∞–≤–Ω–æ–µ –æ—â—É—â–µ–Ω–∏–µ –¥–æ–ª–∂–µ–Ω –≤—ã–∑–≤–∞—Ç—å –¥–∏–∑–∞–π–Ω?', detail: '–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –ø—Ä–æ–µ–∫—Ç–∞'}
                    ];
                }

                STATE.aiQuestions = questions;
                STATE.aiCurrentQuestionIndex = 0;
                STATE.aiAnswers = {};

                addMessage('–í–æ—Ç –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:', false);
                askNextAIQuestion();

            } catch (error) {
                removeTypingIndicator();
                addMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ AI. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –±–∞–∑–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã.', false);

                STATE.aiQuestions = [
                    {q: '–ö—Ç–æ –≤–∞—à–∞ —Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è?', detail: '–ü–æ–º–æ–≥–∞–µ—Ç –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∏–ª—å'},
                    {q: '–ö–∞–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å?', detail: '–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ—Å—ã–ª –¥–∏–∑–∞–π–Ω–∞'},
                    {q: '–ï—Å—Ç—å –ª–∏ –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è?', detail: '–î–∞—ë—Ç –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã'},
                    {q: '–ì–¥–µ —ç—Ç–æ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è?', detail: '–í–ª–∏—è–µ—Ç –Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é'}
                ];
                STATE.aiCurrentQuestionIndex = 0;
                askNextAIQuestion();
            }
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø - –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞:
        function extractFullProjectContext() {
            return {
                type: STATE.answers['q1_projectType'] || '–ø—Ä–æ–µ–∫—Ç',
                audience: STATE.answers['q2_targetAudience'] || '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                purpose: STATE.answers['q3_purpose'] || '–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è',
                // –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∏–µ –∫–ª—é—á–µ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã STATE.answers
                allAnswers: STATE.answers
            };
        }

        function calculateCompletenessScore() {
            const totalQuestions = getQuestionsForMode(STATE.mode).length;
            const answered = Object.keys(STATE.answers).filter(k => STATE.answers[k] !== 'skipped' && STATE.answers[k] !== '').length;
            return Math.round((answered / totalQuestions) * 100);
        }
        
        function askNextAIQuestion() {
            if (STATE.aiCurrentQuestionIndex >= STATE.aiQuestions.length) {
                // All questions answered
                finishAIQuestions();
                return;
            }
            
            const currentQ = STATE.aiQuestions[STATE.aiCurrentQuestionIndex];
            const questionText = typeof currentQ === 'string' ? currentQ : currentQ.q;
            const questionDetail = typeof currentQ === 'object' ? currentQ.detail : '–≠—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –ø–æ–º–æ–∂–µ—Ç —É–ª—É—á—à–∏—Ç—å –¢–ó';
            
            const counter = `${STATE.aiCurrentQuestionIndex + 1}/${STATE.aiQuestions.length}`;
            const messageWithCounter = `${questionText} <span style="color: #2A9A9F; font-weight: 500; margin-left: 8px;">${counter}</span>`;
            
            addMessage(messageWithCounter, false);
            
            // Add "More Info" and "Skip" buttons
            const buttons = [
                {
                    text: '–ü–æ–¥—Ä–æ–±–Ω–µ–µ',
                    action: () => showAIQuestionDetail(questionDetail),
                    class: 'btn-info btn-small',
                    icon: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>'
                },
                {
                    text: '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å',
                    action: () => skipAIQuestion(),
                    class: 'btn-secondary btn-small'
                }
            ];
            addButtons(buttons);
            
            // Enable input for answer
            enableInput('ai-question');
        }
        
        function showAIQuestionDetail(detail) {
            addMessage(detail, false);
        }
        
        function skipAIQuestion() {
            const currentQ = STATE.aiQuestions[STATE.aiCurrentQuestionIndex];
            const questionText = typeof currentQ === 'string' ? currentQ : currentQ.q;
            STATE.aiAnswers[questionText] = '–ü—Ä–æ–ø—É—â–µ–Ω–æ';
            
            addMessage('–ü—Ä–æ–ø—É—â–µ–Ω–æ', true);
            STATE.aiCurrentQuestionIndex++;
            
            setTimeout(() => askNextAIQuestion(), 500);
        }
        
        function finishAIQuestions() {
            addMessage('–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–≤–µ—Ç—ã! –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –¢–ó...', false);
            addTypingIndicator();
            
            setTimeout(() => generateEnhancedBrief(), 1000);
        }
        
        async function generateEnhancedBrief() {
            const currentContent = generateDocumentContent();
            let qaText = '';
            Object.keys(STATE.aiAnswers).forEach(q => {
                // Only include answered questions, not skipped ones
                if (STATE.aiAnswers[q] !== '–ü—Ä–æ–ø—É—â–µ–Ω–æ' && STATE.aiAnswers[q] !== 'skipped') {
                    qaText += `${q}\n${STATE.aiAnswers[q]}\n\n`;
                }
            });
            
            const prompt = `–°–æ–∑–¥–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:

–ò–°–•–û–î–ù–û–ï –¢–ó:
${currentContent}

–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –£–¢–û–ß–ù–ï–ù–ò–Ø:
${qaText}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ—Ç–≤–µ—Ç—É:
- –ü–∏—à–∏ –Ω–∞ —á–∏—Å—Ç–æ–º —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –ë–ï–ó –∑–≤–µ–∑–¥–æ—á–µ–∫ ** –∏ –¥—Ä—É–≥–∏—Ö markdown —Å–∏–º–≤–æ–ª–æ–≤
- –ë–ï–ó —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–π —Ç–∏–ø–∞ q1_, q2_
- –ë–ï–ó –≤—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ—Ä–∞–∑ ("–û—Ç–ª–∏—á–Ω–æ, –¥–∞–≤–∞–π—Ç–µ..." –∏ —Ç.–ø.)
- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –ø–æ —Å–µ–∫—Ü–∏—è–º —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
- –î–æ–±–∞–≤—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∏–∑–∞–π–Ω—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö`;
            
            try {
                const enhancement = await callGeminiAPI(prompt);
                removeTypingIndicator();
                
                const cleanedEnhancement = enhancement
                    .replace(/\*\*/g, '')
                    .replace(/^[\s\S]*?(\u0422–ï–•–ù–ò–ß–ï–°–ö–û–ï|\u0420–ê–°–®–ò–†–ï–ù–ù–û–ï)/i, '$1')
                    .trim();
                
                addMessage('–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ:', false);
                
                const summaryHTML = `<div class="summary-section"><div style="white-space: pre-wrap; line-height: 1.8;">${cleanedEnhancement.replace(/\n/g, '<br>')}</div></div>`;
                addMessage(summaryHTML, false);
                
                STATE.aiEnhancement = cleanedEnhancement;
                
                const buttons = [
                    { text: '–°–∫–∞—á–∞—Ç—å —É–ª—É—á—à–µ–Ω–Ω–æ–µ –¢–ó', action: () => generateDocument(true), class: 'btn-primary', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>' },
                    { text: '–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–≤–æ–¥–∫–µ', action: () => showSummary(), class: 'btn-secondary', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>' }
                ];
                addButtons(buttons);
            } catch (error) {
                removeTypingIndicator();
                addMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–≤—è–∑–∏ —Å AI. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', false);
                setTimeout(() => showSummary(), 1000);
            }
        }
        
        function showAIQuestions() {
            addMessage('–î–∞–≤–∞–π—Ç–µ —É—Ç–æ—á–Ω–∏–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–µ—Ç–∞–ª–∏. –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã:', false);
            
            const chatContainer = document.getElementById('chatContainer');
            const formDiv = document.createElement('div');
            formDiv.className = 'message bot';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="10" rx="2"></rect><circle cx="12" cy="5" r="2"></circle><path d="M12 7v4"></path><line x1="8" y1="16" x2="8" y2="16"></line><line x1="16" y1="16" x2="16" y2="16"></line></svg>';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.style.maxWidth = '90%';
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            
            const questionsContainer = document.createElement('div');
            questionsContainer.className = 'ai-questions-container';
            
            STATE.aiQuestions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'ai-question';
                questionDiv.innerHTML = `
                    <label>${index + 1}. ${question}</label>
                    <textarea id="aiAnswer${index}" rows="2"></textarea>
                `;
                questionsContainer.appendChild(questionDiv);
            });
            
            const buttonsDiv = document.createElement('div');
            buttonsDiv.style.display = 'flex';
            buttonsDiv.style.gap = 'var(--space-8)';
            buttonsDiv.style.marginTop = 'var(--space-16)';
            
            const submitBtn = document.createElement('button');
            submitBtn.className = 'btn btn-primary';
            submitBtn.style.flex = '1';
            submitBtn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                    <polyline points="9 11 12 14 22 4"></polyline>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                </svg>
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            `;
            submitBtn.onclick = submitAIQuestions;
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-secondary';
            cancelBtn.style.flex = '1';
            cancelBtn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                –û—Ç–º–µ–Ω–∏—Ç—å
            `;
            cancelBtn.onclick = () => {
                addMessage('–û—Ç–º–µ–Ω–∞', true);
                setTimeout(() => showSummary(), 500);
            };
            
            buttonsDiv.appendChild(submitBtn);
            buttonsDiv.appendChild(cancelBtn);
            questionsContainer.appendChild(buttonsDiv);
            bubble.appendChild(questionsContainer);
            contentDiv.appendChild(bubble);
            formDiv.appendChild(avatar);
            formDiv.appendChild(contentDiv);
            chatContainer.appendChild(formDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function submitAIQuestions() {
            const answers = [];
            STATE.aiQuestions.forEach((q, index) => {
                const answer = document.getElementById(`aiAnswer${index}`).value.trim();
                answers.push(answer || '–ù–µ —É–∫–∞–∑–∞–Ω–æ');
                STATE.aiAnswers[q] = answer || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            });
            
            addMessage('–û—Ç–≤–µ—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã', true);
            addMessage('–ì–µ–Ω–µ—Ä–∏—Ä—É—é —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ...', false);
            addTypingIndicator();
            
            const currentContent = generateDocumentContent();
            let qaText = '';
            STATE.aiQuestions.forEach((q, i) => {
                qaText += `${q}\n${answers[i]}\n\n`;
            });
            
            const prompt = `–°–æ–∑–¥–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:

–ò–°–•–û–î–ù–û–ï –¢–ó:
${currentContent}

–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –£–¢–û–ß–ù–ï–ù–ò–Ø:
${qaText}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ—Ç–≤–µ—Ç—É:
- –ü–∏—à–∏ –Ω–∞ —á–∏—Å—Ç–æ–º —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –ë–ï–ó –∑–≤–µ–∑–¥–æ—á–µ–∫ ** –∏ –¥—Ä—É–≥–∏—Ö markdown —Å–∏–º–≤–æ–ª–æ–≤
- –ë–ï–ó —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–π —Ç–∏–ø–∞ q1_, q2_
- –ë–ï–ó –≤—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ—Ä–∞–∑ ("–û—Ç–ª–∏—á–Ω–æ, –¥–∞–≤–∞–π—Ç–µ..." –∏ —Ç.–ø.)
- –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π, –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –ø–æ —Å–µ–∫—Ü–∏—è–º —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
- –î–æ–±–∞–≤—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∏–∑–∞–π–Ω—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö`;
            
            try {
                const enhancement = await callGeminiAPI(prompt);
                removeTypingIndicator();
                
                const cleanedEnhancement = enhancement
                    .replace(/\*\*/g, '')
                    .replace(/^[\s\S]*?(\u0422–ï–•–ù–ò–ß–ï–°–ö–û–ï|\u0420–ê–°–®–ò–†–ï–ù–ù–û–ï)/i, '$1')
                    .trim();
                
                addMessage('–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ:', false);
                
                const summaryHTML = `<div class="summary-section"><div style="white-space: pre-wrap; line-height: 1.8;">${cleanedEnhancement.replace(/\n/g, '<br>')}</div></div>`;
                addMessage(summaryHTML, false);
                
                STATE.aiEnhancement = cleanedEnhancement;
                
                const buttons = [
                    { text: '–°–∫–∞—á–∞—Ç—å —É–ª—É—á—à–µ–Ω–Ω–æ–µ –¢–ó', action: () => generateDocument(true), class: 'btn-primary', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>' },
                    { text: '–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–≤–æ–¥–∫–µ', action: () => showSummary(), class: 'btn-secondary', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>' }
                ];
                addButtons(buttons);
            } catch (error) {
                removeTypingIndicator();
                addMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–≤—è–∑–∏ —Å AI. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', false);
                setTimeout(() => showSummary(), 1000);
            }
        }
        
        function generateSummaryHTML() {
            const translations = {
                'q1_projectType': '–¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞',
                'q2_targetAudience': '–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è',
                'q3_purpose': '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è/–ø—Ä–æ–µ–∫—Ç',
                'q4_hasLogo': '–ù–∞–ª–∏—á–∏–µ –ª–æ–≥–æ—Ç–∏–ø–∞',
                'q5_colors': '–¶–≤–µ—Ç–∞',
                'q6_style': '–°—Ç–∏–ª—å',
                'q7_references': '–ü—Ä–∏–º–µ—Ä—ã/—Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã',
                'q8_deadline': '–°—Ä–æ–∫–∏',
                'q9_budget': '–ë—é–¥–∂–µ—Ç',
                'q4_websiteType': '–¢–∏–ø —Å–∞–π—Ç–∞',
                'q1b_materials': '–ù–æ—Å–∏—Ç–µ–ª–∏',
                'q1c_sizes': '–†–∞–∑–º–µ—Ä—ã',
                'qweb1_functionality': '–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å',
                'qweb1b_pages': '–¢–∏–ø —Å–∞–π—Ç–∞ (—Å—Ç—Ä–∞–Ω–∏—Ü—ã)',
                'qweb1c_screens': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–∫—Ä–∞–Ω–æ–≤',
                'qweb1d_crm': 'CRM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è',
                'qweb1e_graphics': '–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç',
                'qweb1f_copywriting': '–¢–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç',
                'qweb2_responsive': '–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å',
                'qweb3_integrations': '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏',
                'qweb4_seo': 'SEO',
                'qweb5_content': '–ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º',
                'qweb6_languages': '–ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å',
                'qweb7_animation': '–ê–Ω–∏–º–∞—Ü–∏–∏'
            };
            
            let html = '<div class="summary-section">';
            html += '<h3 style="margin-bottom: var(--space-12);">–î–µ—Ç–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞</h3>';
            
            Object.keys(STATE.answers).forEach(key => {
                // EXCLUDE skipped questions from summary
                if (STATE.answers[key] !== 'skipped') {
                    const label = translations[key] || key.replace(/^q\d+[a-z]?_/, '').replace(/_/g, ' ');
                    html += `<div class="summary-item">`;
                    html += `<div class="summary-label">${label}</div>`;
                    html += `<div class="summary-value">${STATE.answers[key]}</div>`;
                    html += `</div>`;
                }
            });
            
            html += '</div>';
            return html;
        }

        function showEditOptions() {
            addMessage('–ò–∑–º–µ–Ω–∏—Ç—å', true);
            
            setTimeout(() => {
                addMessage('–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å?', false);
                
                const translations = {
                    'q1_projectType': '–¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞',
                    'q2_targetAudience': '–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è',
                    'q3_purpose': '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è/–ø—Ä–æ–µ–∫—Ç',
                    'q4_hasLogo': '–ù–∞–ª–∏—á–∏–µ –ª–æ–≥–æ—Ç–∏–ø–∞',
                    'q5_colors': '–¶–≤–µ—Ç–∞',
                    'q6_style': '–°—Ç–∏–ª—å',
                    'q7_references': '–ü—Ä–∏–º–µ—Ä—ã/—Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã',
                    'q8_deadline': '–°—Ä–æ–∫–∏',
                    'q9_budget': '–ë—é–¥–∂–µ—Ç',
                    'q4_websiteType': '–¢–∏–ø —Å–∞–π—Ç–∞'
                };
                
                const editableQuestions = getEditableQuestions();
                const buttons = editableQuestions.map(q => {
                    const key = q.key || q.text;
                    const displayText = translations[key] || q.text;
                    return {
                        text: displayText,
                        action: () => editQuestion(q),
                        class: 'btn-secondary'
                    };
                });
                
                buttons.push({
                    text: '‚ùå –û—Ç–º–µ–Ω–∞',
                    action: () => { addMessage('–û—Ç–º–µ–Ω–∞', true); setTimeout(() => showSummary(), 500); },
                    class: 'btn-secondary'
                });
                
                addButtons(buttons);
            }, 500);
        }

        function getEditableQuestions() {
            const questions = getQuestionsForMode(STATE.mode);
            return questions.filter(q => {
                const key = q.key || q.text;
                return STATE.answers[key] !== undefined;
            });
        }

        function editQuestion(question) {
            const translations = {
                'q1_projectType': '–¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞',
                'q2_targetAudience': '–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è',
                'q3_purpose': '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è/–ø—Ä–æ–µ–∫—Ç',
                'q4_hasLogo': '–ù–∞–ª–∏—á–∏–µ –ª–æ–≥–æ—Ç–∏–ø–∞',
                'q5_colors': '–¶–≤–µ—Ç–∞',
                'q6_style': '–°—Ç–∏–ª—å',
                'q7_references': '–ü—Ä–∏–º–µ—Ä—ã/—Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã',
                'q8_deadline': '–°—Ä–æ–∫–∏',
                'q9_budget': '–ë—é–¥–∂–µ—Ç',
                'q4_websiteType': '–¢–∏–ø —Å–∞–π—Ç–∞'
            };
            
            const key = question.key || question.text;
            const displayText = translations[key] || question.text;
            addMessage(displayText, true);
            
            setTimeout(() => {
                STATE.isEditing = true;
                
                STATE.currentQuestion = question.text;
                addMessage(question.text, false, question.hasDetail || false, question.hint || null);
                
                if (question.type === 'buttons') {
                    addButtons(question.options.map(opt => ({
                        text: opt.text,
                        action: () => {
                            STATE.answers[key] = opt.value;
                            addMessage(opt.text, true);
                            STATE.isEditing = false;
                            setTimeout(() => showSummary(), 500);
                        },
                        class: 'btn-secondary'
                    })));
                } else if (question.type === 'colors') {
                    // Parse existing colors from STATE.answers[key]
                    const existingColorsStr = STATE.answers[key] || '';
                    const existingColors = existingColorsStr.split(',').map(c => c.trim().toUpperCase()).filter(c => c.startsWith('#'));
                    STATE.selectedColors = existingColors.length > 0 ? existingColors : [];
                    
                    const origIndex = STATE.questionIndex;
                    const questions = getQuestionsForMode(STATE.mode);
                    STATE.questionIndex = questions.findIndex(q => (q.key || q.text) === key);
                    showColorPalettes();
                } else if (question.type === 'style') {
                    const origIndex = STATE.questionIndex;
                    const questions = getQuestionsForMode(STATE.mode);
                    STATE.questionIndex = questions.findIndex(q => (q.key || q.text) === key);
                    showStyles();
                } else if (question.type === 'file') {
                    if (STATE.uploadedFiles.length > 0) {
                        addMessage(`–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã: ${STATE.uploadedFiles.length}`, false);
                    }
                    showFileUpload(key);
                } else {
                    enableInput('edit');
                    document.getElementById('userInput').onkeypress = (e) => {
                        if (e.key === 'Enter') {
                            const value = document.getElementById('userInput').value.trim();
                            if (value) {
                                STATE.answers[key] = value;
                                addMessage(value, true);
                                document.getElementById('userInput').value = '';
                                document.getElementById('userInput').disabled = true;
                                STATE.isEditing = false;
                                setTimeout(() => showSummary(), 500);
                            }
                        }
                    };
                }
            }, 500);
        }

        async function generateDocument(withAI = false) {
            addMessage(withAI ? '–°–∫–∞—á–∞—Ç—å —É–ª—É—á—à–µ–Ω–Ω–æ–µ –¢–ó' : '–ì–æ—Ç–æ–≤–æ, —Å–∫–∞—á–∞—Ç—å –¢–ó –≤ PDF', true);
            addMessage('–§–æ—Ä–º–∏—Ä—É—é —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –≤ PDF...', false);
            addTypingIndicator();
            
            setTimeout(() => {
                removeTypingIndicator();
                downloadDocument('pdf', withAI);
                addMessage('‚úÖ PDF –¥–æ–∫—É–º–µ–Ω—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—é!', false);
            }, 2000);
        }

        function downloadDocument(format, withAI = false) {
            const htmlContent = generateHTMLForPDF(withAI);
            
            const element = document.createElement('div');
            element.innerHTML = htmlContent;
            element.style.padding = '20px';
            element.style.background = '#ffffff';
            element.style.color = '#000000';
            
            const opt = {
                margin: [15, 15, 15, 15],
                filename: withAI ? '—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ_–∑–∞–¥–∞–Ω–∏–µ_AI.pdf' : '—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ_–∑–∞–¥–∞–Ω–∏–µ.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        function generateDocumentContent() {
            let content = `–¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ó–ê–î–ê–ù–ò–ï\n\n`;
            content += `–†–µ–∂–∏–º: ${MODES[STATE.mode].name}\n\n`;
            content += `–ö–û–ù–¢–ê–ö–¢–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:\n`;
            content += `–ò–º—è: ${STATE.contactInfo.name}\n`;
            content += `–ö–æ–Ω—Ç–∞–∫—Ç: ${STATE.contactInfo.contact}\n`;
            if (STATE.contactInfo.organization) {
                content += `–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è: ${STATE.contactInfo.organization}\n`;
            }
            content += `\n`;
            content += `–î–ï–¢–ê–õ–ò –ü–†–û–ï–ö–¢–ê:\n`;
            
            // ONLY include answered questions, exclude skipped
            Object.keys(STATE.answers).forEach(key => {
                if (STATE.answers[key] !== 'skipped' && STATE.answers[key]) {
                    const cleanKey = key.replace(/^q\d+[a-z]?_/, '').replace(/_/g, ' ');
                    content += `${cleanKey}: ${STATE.answers[key]}\n`;
                }
            });
            
            return content;
        }

        function generateHTMLForPDF(withAI = false) {
            const translations = {
                'q1_projectType': '–¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞',
                'q1b_materials': '–ù–æ—Å–∏—Ç–µ–ª–∏',
                'q1c_sizes': '–†–∞–∑–º–µ—Ä—ã',
                'q1d_quantity': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
                'q1e_platform': '–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞',
                'q2_targetAudience': '–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è',
                'q3_purpose': '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è/–ø—Ä–æ–µ–∫—Ç',
                'q4_hasLogo': '–ù–∞–ª–∏—á–∏–µ –ª–æ–≥–æ—Ç–∏–ø–∞',
                'q4_websiteType': '–¢–∏–ø —Å–∞–π—Ç–∞',
                'q5_colors': '–¶–≤–µ—Ç–∞',
                'q6_style': '–°—Ç–∏–ª—å',
                'q7_references': '–ü—Ä–∏–º–µ—Ä—ã/—Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã',
                'q8_deadline': '–°—Ä–æ–∫–∏',
                'q9_budget': '–ë—é–¥–∂–µ—Ç',
                'qweb1_functionality': '–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å',
                'qweb1b_pages': '–¢–∏–ø —Å–∞–π—Ç–∞ (—Å—Ç—Ä–∞–Ω–∏—Ü—ã)',
                'qweb1c_screens': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–∫—Ä–∞–Ω–æ–≤',
                'qweb1d_crm': 'CRM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è',
                'qweb1e_graphics': '–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç',
                'qweb1f_copywriting': '–¢–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç',
                'qweb2_responsive': '–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å',
                'qweb3_integrations': '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏',
                'qweb4_seo': 'SEO',
                'qweb5_content': '–ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º',
                'qweb6_languages': '–ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å',
                'qweb7_animation': '–ê–Ω–∏–º–∞—Ü–∏–∏',
                'qpoly1_printtech': '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è –ø–µ—á–∞—Ç–∏',
                'qpoly2_format': '–§–æ—Ä–º–∞—Ç',
                'qpoly3_material': '–ú–∞—Ç–µ—Ä–∏–∞–ª',
                'qpoly4_folding': '–°–≥–∏–±–∞–Ω–∏–µ/–°–ª–æ–∂–µ–Ω–∏–µ',
                'qpoly5_finishing': '–û—Ç–¥–µ–ª–∫–∞'
            };
            
            let html = `
            <div style="font-family: Arial, sans-serif; line-height: 1.6;">
                <h1 style="color: #333; border-bottom: 3px solid #667eea; padding-bottom: 10px;">–¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ó–ê–î–ê–ù–ò–ï</h1>
                
                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h2 style="color: #667eea; margin-top: 0;">–†–µ–∂–∏–º</h2>
                    <p>${MODES[STATE.mode].name}</p>
                </div>
                
                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h2 style="color: #667eea; margin-top: 0;">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                    <p><strong>–ò–º—è:</strong> ${STATE.contactInfo.name}</p>
                    <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç:</strong> ${STATE.contactInfo.contact}</p>
                </div>
                
                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h2 style="color: #667eea; margin-top: 0;">–î–µ—Ç–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞</h2>`;
            
            Object.keys(STATE.answers).forEach(key => {
                if (STATE.answers[key] !== 'skipped' && STATE.answers[key] !== 'uploaded') {
                    const label = translations[key] || key;
                    html += `<p><strong>${label}:</strong> ${STATE.answers[key]}</p>`;
                }
            });
            
            html += `</div>`;
            
            if (withAI && STATE.aiEnhancement) {
                const cleanEnhancement = STATE.aiEnhancement
                    .replace(/\*\*/g, '')
                    .replace(/\*/g, '')
                    .replace(/#/g, '')
                    .replace(/q\d+_\w+/g, '')
                    .trim();
                html += `<div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h2 style="color: #2A9A9F; margin-top: 0;">–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –¢–ó</h2>
                    <div style="white-space: pre-wrap; line-height: 1.8;">${cleanEnhancement.replace(/\n/g, '<br>')}</div>
                </div>`;
            }
            
            if (STATE.uploadedLinks && STATE.uploadedLinks.length > 0) {
                html += `<div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h2 style="color: #2A9A9F; margin-top: 0;">–†–µ—Ñ–µ—Ä–µ–Ω—Å–Ω—ã–µ —Å—Å—ã–ª–∫–∏</h2>`;
                STATE.uploadedLinks.forEach(link => {
                    html += `<p><a href="${link}" target="_blank" style="color: #2A9A9F;">${link}</a></p>`;
                });
                html += `</div>`;
            }
            
            if (STATE.uploadedImages && STATE.uploadedImages.length > 0) {
                html += `<div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h2 style="color: #667eea; margin-top: 0;">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h2>`;
                STATE.uploadedImages.forEach(img => {
                    html += `<img src="${img}" style="max-width: 100%; height: auto; margin: 10px 0; border-radius: 8px;" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞">`;
                });
                html += `</div>`;
            }
            
            html += `</div>`;
            return html;
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showTemplateMode() {
            addMessage('–†–µ–∂–∏–º —à–∞–±–ª–æ–Ω–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:', false);
            
            const buttons = [
                { text: `${MODES.graphic.name}`, action: () => showTemplateForm('graphic'), class: 'btn-secondary' },
                { text: `${MODES.web.name}`, action: () => showTemplateForm('web'), class: 'btn-secondary' },
                { text: `${MODES.polygraphy.name}`, action: () => showTemplateForm('polygraphy'), class: 'btn-secondary' }
            ];
            
            addButtons(buttons);
        }

        function showTemplateForm(direction) {
            addMessage(`–í—ã–±—Ä–∞–Ω–æ: ${MODES[direction].name}`, true);
            STATE.mode = direction;
            
            setTimeout(() => {
                const chatContainer = document.getElementById('chatContainer');
                const formDiv = document.createElement('div');
                formDiv.className = 'message bot';
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = 'ü§ñ';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.style.maxWidth = '90%';
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.innerHTML = `
                    <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –±–ª–∞–Ω–∫ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è:</p>
                    <div class="template-form">
                        <div class="form-group">
                            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ *</label>
                            <input type="text" id="template-name" required>
                        </div>
                        <div class="form-group">
                            <label>–í–∞—à–µ –∏–º—è *</label>
                            <input type="text" id="template-contact-name" required>
                        </div>
                        <div class="form-group">
                            <label>–ö–æ–Ω—Ç–∞–∫—Ç (email/—Ç–µ–ª–µ—Ñ–æ–Ω) *</label>
                            <input type="text" id="template-contact" required>
                        </div>
                        <div class="form-group">
                            <label>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</label>
                            <input type="text" id="template-org">
                        </div>
                        <div class="form-group">
                            <label>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ *</label>
                            <textarea id="template-description" required></textarea>
                        </div>
                        <div class="form-group">
                            <label>–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è</label>
                            <input type="text" id="template-audience">
                        </div>
                        <div class="form-group">
                            <label>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–µ–∫—Ç—É</label>
                            <textarea id="template-requirements"></textarea>
                        </div>
                        <div class="form-group">
                            <label>–°—Ç–∏–ª—å</label>
                            <select id="template-style">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å</option>
                                <option value="minimalism">–ú–∏–Ω–∏–º–∞–ª–∏–∑–º</option>
                                <option value="vibrant">–Ø—Ä–∫–∏–µ —Ü–≤–µ—Ç–∞</option>
                                <option value="geometry">–ì–µ–æ–º–µ—Ç—Ä–∏—è</option>
                                <option value="classic">–ö–ª–∞—Å—Å–∏–∫–∞</option>
                                <option value="modern">–ú–æ–¥–µ—Ä–Ω</option>
                                <option value="custom">–î—Ä—É–≥–æ–π (—É–∫–∞–∑–∞—Ç—å –Ω–∏–∂–µ)</option>
                            </select>
                            <input type="text" id="template-style-custom" placeholder="–£–∫–∞–∂–∏—Ç–µ —Å–≤–æ–π —Å—Ç–∏–ª—å..." style="margin-top: 8px; display: none;">
                        </div>
                        <div class="form-group">
                            <label>–¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞</label>
                            <div id="templatePaletteSelect" style="margin-bottom: 12px;"></div>
                            <div style="margin-top: 12px;">
                                <label style="font-size: 12px; color: #b0b0b0;">–ò–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏ —Ü–≤–µ—Ç–∞:</label>
                                <div style="display: flex; gap: 8px; align-items: center; margin-top: 8px;">
                                    <input type="color" id="templateColorPicker" value="#2A9A9F">
                                    <button type="button" class="btn-add-color" onclick="addTemplateColor()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                                </div>
                                <div id="templateCustomColors" style="margin-top: 12px;"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>–ü—Ä–∏–º–µ—Ä—ã / –†–µ—Ñ–µ—Ä–µ–Ω—Å—ã</label>
                            <div class="tabs-container">
                                <button type="button" class="tab-button active" onclick="switchTemplateTab('images')">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                        <polyline points="21 15 16 10 5 21"></polyline>
                                    </svg>
                                    –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                                </button>
                                <button type="button" class="tab-button" onclick="switchTemplateTab('links')">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                                    </svg>
                                    –°—Å—ã–ª–∫–∏
                                </button>
                            </div>
                            <div id="templateImagesTab" class="tab-content active">
                                <input type="file" accept="image/*" multiple id="templateFileInput" style="margin-top: 12px;">
                                <div id="templateUploadedCount" style="margin-top: 8px; color: #2A9A9F;"></div>
                            </div>
                            <div id="templateLinksTab" class="tab-content">
                                <div style="display: flex; gap: 8px; margin-top: 12px;">
                                    <input type="text" id="templateLinkInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É..." style="flex: 1;">
                                    <button type="button" class="btn btn-primary" onclick="addTemplateLink()">–î–æ–±–∞–≤–∏—Ç—å</button>
                                </div>
                                <div id="templateLinksList" style="margin-top: 12px;"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>–°—Ä–æ–∫–∏</label>
                            <input type="text" id="template-deadline">
                        </div>
                        <div class="form-group">
                            <label>–ë—é–¥–∂–µ—Ç</label>
                            <input type="text" id="template-budget">
                        </div>
                        <div class="form-group">
                            <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                            <textarea id="template-notes"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="submitTemplateForm()" style="width: 100%; margin-top: 10px;">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –¢–ó</button>
                    </div>
                `;
                
                contentDiv.appendChild(bubble);
                formDiv.appendChild(avatar);
                formDiv.appendChild(contentDiv);
                chatContainer.appendChild(formDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                document.getElementById('userInput').disabled = true;
                
                setTimeout(() => initializeTemplate(), 100);
            }, 500);
        }

        const TEMPLATE_STATE = {
            selectedPalette: null,
            customColors: [],
            uploadedFiles: [],
            uploadedLinks: []
        };

        function initializeTemplate() {
            const paletteSelect = document.getElementById('templatePaletteSelect');
            if (!paletteSelect) return;
            
            const shuffled = shuffleArray(COLOR_PALETTES).slice(0, 5);
            shuffled.forEach((palette, index) => {
                const item = document.createElement('div');
                item.className = 'color-palette-item';
                item.style.cursor = 'pointer';
                item.style.marginBottom = '8px';
                item.onclick = () => selectTemplatePalette(palette, item);
                
                const name = document.createElement('div');
                name.className = 'color-palette-name';
                name.textContent = palette.name;
                
                const colorsDiv = document.createElement('div');
                colorsDiv.className = 'color-palette-colors';
                
                palette.colors.forEach(color => {
                    const swatch = document.createElement('div');
                    swatch.className = 'color-palette-swatch';
                    swatch.style.backgroundColor = color;
                    colorsDiv.appendChild(swatch);
                });
                
                item.appendChild(name);
                item.appendChild(colorsDiv);
                paletteSelect.appendChild(item);
            });
            
            document.getElementById('template-style').addEventListener('change', function() {
                const customInput = document.getElementById('template-style-custom');
                customInput.style.display = this.value === 'custom' ? 'block' : 'none';
            });
            
            document.getElementById('templateFileInput').addEventListener('change', function(e) {
                const files = e.target.files;
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        TEMPLATE_STATE.uploadedFiles.push({ name: file.name, data: ev.target.result });
                        updateTemplateUploadCount();
                    };
                    reader.readAsDataURL(file);
                });
            });
        }

        function selectTemplatePalette(palette, element) {
            palette.colors.forEach(color => {
                if (!TEMPLATE_STATE.customColors.includes(color.toUpperCase())) {
                    TEMPLATE_STATE.customColors.push(color.toUpperCase());
                }
            });
            displayTemplateCustomColors();
            
            document.querySelectorAll('#templatePaletteSelect .color-palette-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
        }

        function addTemplateColor() {
            const picker = document.getElementById('templateColorPicker');
            const color = picker.value.toUpperCase();
            
            if (!TEMPLATE_STATE.customColors.includes(color)) {
                TEMPLATE_STATE.customColors.push(color);
                displayTemplateCustomColors();
            }
        }

        function displayTemplateCustomColors() {
            const display = document.getElementById('templateCustomColors');
            if (!display) return;
            
            display.innerHTML = '';
            TEMPLATE_STATE.customColors.forEach((color, index) => {
                const item = document.createElement('div');
                item.className = 'custom-color-item';
                item.innerHTML = `
                    <div class="custom-color-swatch" style="background-color: ${color};"></div>
                    <span class="custom-color-hex">${color}</span>
                    <button type="button" class="btn-remove-color" onclick="removeTemplateColor(${index})">√ó</button>
                `;
                display.appendChild(item);
            });
        }

        function removeTemplateColor(index) {
            TEMPLATE_STATE.customColors.splice(index, 1);
            displayTemplateCustomColors();
        }

        function switchTemplateTab(tabName) {
            document.querySelectorAll('#templateImagesTab, #templateLinksTab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tabs-container .tab-button').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById('template' + tabName.charAt(0).toUpperCase() + tabName.slice(1) + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        function addTemplateLink() {
            const input = document.getElementById('templateLinkInput');
            const url = input.value.trim();
            
            if (!url) return;
            
            TEMPLATE_STATE.uploadedLinks.push(url);
            input.value = '';
            displayTemplateLinks();
        }

        function displayTemplateLinks() {
            const list = document.getElementById('templateLinksList');
            if (!list) return;
            
            list.innerHTML = '';
            TEMPLATE_STATE.uploadedLinks.forEach((link, index) => {
                const item = document.createElement('div');
                item.className = 'link-item';
                item.innerHTML = `
                    <a href="${link}" target="_blank">${link}</a>
                    <button type="button" class="btn-remove-link" onclick="removeTemplateLink(${index})">√ó</button>
                `;
                list.appendChild(item);
            });
        }

        function removeTemplateLink(index) {
            TEMPLATE_STATE.uploadedLinks.splice(index, 1);
            displayTemplateLinks();
        }

        function updateTemplateUploadCount() {
            const count = document.getElementById('templateUploadedCount');
            if (count && TEMPLATE_STATE.uploadedFiles.length > 0) {
                count.textContent = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${TEMPLATE_STATE.uploadedFiles.length} —Ñ–∞–π–ª–æ–≤`;
            }
        }

        function submitTemplateForm() {
            const name = document.getElementById('template-name').value.trim();
            const contactName = document.getElementById('template-contact-name').value.trim();
            const contact = document.getElementById('template-contact').value.trim();
            
            if (!name || !contactName || !contact) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ *)');
                return;
            }
            
            STATE.contactInfo = {
                name: contactName,
                contact: contact,
                organization: document.getElementById('template-org').value.trim() || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'
            };
            
            const styleSelect = document.getElementById('template-style');
            const styleValue = styleSelect.value === 'custom' ? 
                document.getElementById('template-style-custom').value.trim() || '–ù–µ —É–∫–∞–∑–∞–Ω' :
                (styleSelect.options[styleSelect.selectedIndex].text || '–ù–µ –≤—ã–±—Ä–∞–Ω');
            
            let colorsValue = '';
            if (TEMPLATE_STATE.selectedPalette) {
                colorsValue = `–ü–∞–ª–∏—Ç—Ä–∞: ${TEMPLATE_STATE.selectedPalette.name}`;
                if (TEMPLATE_STATE.customColors.length > 0) {
                    colorsValue += ` + ${TEMPLATE_STATE.customColors.length} —Å–≤–æ–∏—Ö —Ü–≤–µ—Ç–∞`;
                }
            } else if (TEMPLATE_STATE.customColors.length > 0) {
                colorsValue = `–í—ã–±—Ä–∞–Ω–æ ${TEMPLATE_STATE.customColors.length} —Ü–≤–µ—Ç–æ–≤: ${TEMPLATE_STATE.customColors.join(', ')}`;
            } else {
                colorsValue = '–ù–µ —É–∫–∞–∑–∞–Ω—ã';
            }
            
            STATE.uploadedFiles = TEMPLATE_STATE.uploadedFiles;
            STATE.uploadedLinks = TEMPLATE_STATE.uploadedLinks;
            STATE.uploadedImages = TEMPLATE_STATE.uploadedFiles.map(f => f.data);
            
            STATE.answers = {
                '–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞': name,
                '–û–ø–∏—Å–∞–Ω–∏–µ': document.getElementById('template-description').value.trim() || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                '–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è': document.getElementById('template-audience').value.trim() || '–ù–µ —É–∫–∞–∑–∞–Ω–∞',
                '–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è': document.getElementById('template-requirements').value.trim() || '–ù–µ —É–∫–∞–∑–∞–Ω—ã',
                '–°—Ç–∏–ª—å': styleValue,
                '–¶–≤–µ—Ç–∞': colorsValue,
                '–°—Ä–æ–∫–∏': document.getElementById('template-deadline').value.trim() || '–ù–µ —É–∫–∞–∑–∞–Ω—ã',
                '–ë—é–¥–∂–µ—Ç': document.getElementById('template-budget').value.trim() || '–ù–µ —É–∫–∞–∑–∞–Ω',
                '–ü—Ä–∏–º–µ—á–∞–Ω–∏—è': document.getElementById('template-notes').value.trim() || '–ù–µ—Ç'
            };
            
            addMessage('–ë–ª–∞–Ω–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω', true);
            generateDocument();
        }

        function getThemeBasedHint(question, mode) {
            if (!question.hint) return null;
            
            const hintMap = {
                'graphic': {
                    'q1_projectType': '–ù–∞–ø—Ä–∏–º–µ—Ä: –ª–æ–≥–æ—Ç–∏–ø, —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å, —É–ø–∞–∫–æ–≤–∫–∞',
                    'q2_targetAudience': '–ù–∞–ø—Ä–∏–º–µ—Ä: –º–æ–ª–æ–¥—ã–µ –º–∞–º—ã 25-35 –ª–µ—Ç, IT-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã',
                    'q3_purpose': '–ù–∞–ø—Ä–∏–º–µ—Ä: –∫–æ–º–ø–∞–Ω–∏—è, –ª–∏—á–Ω—ã–π –ø—Ä–æ–µ–∫—Ç, —Å–æ–æ–±—â–µ—Å—Ç–≤–æ',
                    'q1b_materials': '–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–µ—á–∞—Ç—å, —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏, —É–ø–∞–∫–æ–≤–∫–∞, –Ω–∞—Ä—É–∂–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞'
                },
                'web': {
                    'q1_projectType': '–ù–∞–ø—Ä–∏–º–µ—Ä: –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–≤–∞—Ä–∞, –∫–∞–±–∏–Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
                    'q2_targetAudience': '–ù–∞–ø—Ä–∏–º–µ—Ä: –º–æ–ª–æ–¥—ã–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—ã, —Å—Ç—É–¥–µ–Ω—Ç—ã, –ø–µ–Ω—Å–∏–æ–Ω–µ—Ä—ã',
                    'q3_purpose': '–ù–∞–ø—Ä–∏–º–µ—Ä: –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω, –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Å–∞–π—Ç, –±–ª–æ–≥',
                    'q1b_materials': '–ù–∞–ø—Ä–∏–º–µ—Ä: –¥–µ—Å–∫—Ç–æ–ø, –º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è, –æ–±–∞'
                },
                'polygraphy': {
                    'q1_projectType': '–ù–∞–ø—Ä–∏–º–µ—Ä: –ª–∏—Å—Ç–æ–≤–∫–∏, –±—É–∫–ª–µ—Ç—ã, –æ—Ç–∫—Ä—ã—Ç–∫–∏, –≤–∏–∑–∏—Ç–∫–∏',
                    'q2_targetAudience': '–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ –≤—ã—Å—Ç–∞–≤–∫–∏, –∫–ª–∏–µ–Ω—Ç—ã —Å–∞–ª–æ–Ω–∞, —É—á–∞—Å—Ç–Ω–∏–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è',
                    'q3_purpose': '–ù–∞–ø—Ä–∏–º–µ—Ä: –ø—Ä–æ–º–æ-–∞–∫—Ü–∏—è, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª, –∏–º–∏–¥–∂–µ–≤–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è',
                    'q1b_materials': '–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–µ—á–∞—Ç—å, —Ä–∞–∑–º–µ—Ä—ã, –±—É–º–∞–≥–∞, –ª–∞–º–∏–Ω–∞—Ü–∏—è'
                }
            };
            
            const questionKey = question.key || question.text;
            if (hintMap[mode] && hintMap[mode][questionKey]) {
                return hintMap[mode][questionKey];
            }
            
            return question.hint;
        }
        
        function getQuestionsForMode(mode) {
            const commonQuestions = [
                {
                    key: 'q1_projectType',
                    text: STATE.mode === 'graphic' ? '–ö–∞–∫–æ–π —Ç–∏–ø –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞ –≤–∞–º –Ω—É–∂–µ–Ω?' : (STATE.mode === 'polygraphy' ? '–ö–∞–∫–∏–µ –ø–µ—á–∞—Ç–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤–∞–º –Ω—É–∂–Ω—ã?' : '–ö–∞–∫–æ–π —Ç–∏–ø –ø—Ä–æ–µ–∫—Ç–∞ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ?'),
                    type: 'text',
                    hasDetail: true,
                    detailText: STATE.mode === 'graphic' ? '–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω –≤–∫–ª—é—á–∞–µ—Ç: –ª–æ–≥–æ—Ç–∏–ø—ã, —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å, –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏, –±–∞–Ω–Ω–µ—Ä—ã, –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫—É, —É–ø–∞–∫–æ–≤–∫—É –∏ –¥—Ä—É–≥–æ–µ. –ö–∞–∂–¥—ã–π —Ç–∏–ø –∏–º–µ–µ—Ç —Å–≤–æ–∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏.' : (STATE.mode === 'polygraphy' ? '–ü–æ–ª–∏–≥—Ä–∞—Ñ–∏—è –≤–∫–ª—é—á–∞–µ—Ç: –≤–∏–∑–∏—Ç–∫–∏, –±—É–∫–ª–µ—Ç—ã, –ª–∏—Å—Ç–æ–≤–∫–∏, –ø–ª–∞–∫–∞—Ç—ã, –∫–∞–ª–µ–Ω–¥–∞—Ä–∏, –æ—Ç–∫—Ä—ã—Ç–∫–∏ –∏ –¥—Ä—É–≥–æ–µ. –£–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞–º –Ω—É–∂–Ω–æ.' : '–¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤–∏–¥ –¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫–æ–π —Ä–∞–±–æ—Ç—ã. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å: –ª–æ–≥–æ—Ç–∏–ø (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∑–Ω–∞–∫ –±—Ä–µ–Ω–¥–∞), —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å (–∫–æ–º–ø–ª–µ–∫—Å –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤), —É–ø–∞–∫–æ–≤–∫–∞, –≤–µ–±-–¥–∏–∑–∞–π–Ω, –ø–µ—á–∞—Ç–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è (–≤–∏–∑–∏—Ç–∫–∏, –±—É–∫–ª–µ—Ç—ã, –ø–ª–∞–∫–∞—Ç—ã) –∏–ª–∏ –¥—Ä—É–≥–æ–µ. –ö–∞–∂–¥—ã–π —Ç–∏–ø –∏–º–µ–µ—Ç —Å–≤–æ–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏.'),
                    hint: 'theme-based'
                },
                {
                    key: 'q1b_materials',
                    text: '–ù–∞ –∫–∞–∫–∏—Ö –Ω–æ—Å–∏—Ç–µ–ª—è—Ö –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–∏–∑–∞–π–Ω?',
                    type: 'text',
                    hasDetail: true,
                    detailText: '–í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å, –≥–¥–µ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è –¥–∏–∑–∞–π–Ω: –Ω–∞ –±—É–º–∞–≥–µ, —ç–∫—Ä–∞–Ω–∞—Ö, —É–ø–∞–∫–æ–≤–∫–µ, —Ç–∫–∞–Ω–∏ –∏ —Ç.–¥. –≠—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ñ–æ—Ä–º–∞—Ç—ã, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è.',
                    hint: 'theme-based'
                },
                {
                    key: 'q1c_sizes',
                    text: '–ö–∞–∫–∏–µ —Ä–∞–∑–º–µ—Ä—ã –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã?',
                    type: 'text',
                    hasDetail: true,
                    detailText: '–£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç—ã. –ù–∞–ø—Ä–∏–º–µ—Ä: A4, 1920x1080px, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –≤–∏–∑–∏—Ç–∫–∏ 90x50–º–º. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –º–∞–∫–µ—Ç—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–æ–ø–æ—Ä—Ü–∏—è–º–∏.',
                    hint: '–ù–∞–ø—Ä–∏–º–µ—Ä: A4, 1920x1080, –ª—é–±—ã–µ —Ä–∞–∑–º–µ—Ä—ã'
                },
                {
                    key: 'q1d_quantity',
                    text: '–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –ª–∏ —Ç–∏—Ä–∞–∂ –∏–ª–∏ –ø–µ—á–∞—Ç—å?',
                    type: 'text',
                    hasDetail: true,
                    detailText: '–ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç –ø–µ—á–∞—Ç—å, —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏–º–µ—Ä–Ω—ã–π —Ç–∏—Ä–∞–∂. –≠—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –ø–µ—á–∞—Ç–∏ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É —Ñ–∞–π–ª–æ–≤.',
                    hint: '–ù–∞–ø—Ä–∏–º–µ—Ä: 100 —à—Ç—É–∫, 1000 —ç–∫–∑., –Ω–µ—Ç'
                },
                {
                    key: 'q1e_platform',
                    text: '–ì–¥–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–∏–∑–∞–π–Ω?',
                    type: 'text',
                    hasDetail: true,
                    detailText: '–£–∫–∞–∂–∏—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –∏–ª–∏ –∫–∞–Ω–∞–ª—ã: —Å–æ—Ü—Å–µ—Ç–∏ (Instagram, VK), —Å–∞–π—Ç, –ø–µ—á–∞—Ç–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –Ω–∞—Ä—É–∂–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞ –∏ —Ç.–¥.',
                    hint: '–ù–∞–ø—Ä–∏–º–µ—Ä: —Å–æ—Ü—Å–µ—Ç–∏, —Å–∞–π—Ç, –ø–µ—á–∞—Ç–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã'
                },
                {
                    key: 'q2_targetAudience',
                    text: '–ö—Ç–æ –±—É–¥–µ—Ç —Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —ç—Ç–æ? (–≤–∞—à–∞ —Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è)',
                    type: 'text',
                    hasDetail: true,
                    detailText: '–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è ‚Äî —ç—Ç–æ –≥—Ä—É–ø–ø–∞ –ª—é–¥–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –≤–∞—à–∏–º –ø—Ä–æ–¥—É–∫—Ç–æ–º. –ü–æ–Ω–∏–º–∞–Ω–∏–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –¥–∏–∑–∞–π–Ω–∞, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–æ –ø–æ–º–æ–≥–∞–µ—Ç –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞, —Å—Ç–∏–ª–∏, —à—Ä–∏—Ñ—Ç—ã –∏ –æ–±—â—É—é –∫–æ–Ω—Ü–µ–ø—Ü–∏—é, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∑–æ–Ω–∏—Ä—É—é—Ç —Å –≤–∞—à–µ–π –∞—É–¥–∏—Ç–æ—Ä–∏–µ–π.',
                    hint: 'theme-based'
                },
                {
                    key: 'q3_purpose',
                    text: '–≠—Ç–æ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏, –ª–∏—á–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞?',
                    type: 'text',
                    hasDetail: true,
                    detailText: '–ü–æ–Ω–∏–º–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ–º–æ–≥–∞–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–∞—Å—à—Ç–∞–±, —Ç–æ–Ω –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –∏ —Å—Ç–∏–ª—å. –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã —á–∞—Å—Ç–æ —Ç—Ä–µ–±—É—é—Ç –±–æ–ª–µ–µ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞, –ª–∏—á–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –±–æ–ª–µ–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–º–∏, –∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ —á–∞—Å—Ç–æ –Ω—É–∂–¥–∞—é—Ç—Å—è –≤ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–º –∏ –≤–∫–ª—é—á–∞—é—â–µ–º –¥–∏–∑–∞–π–Ω–µ.',
                    hint: 'theme-based'
                },
                {
                    key: 'q4_hasLogo',
                    text: '–ï—Å—Ç—å –ª–∏ —É–∂–µ –ª–æ–≥–æ—Ç–∏–ø –∏–ª–∏ —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å?',
                    type: 'buttons',
                    hasDetail: true,
                    detailText: '–õ–æ–≥–æ—Ç–∏–ø –∏ —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å ‚Äî —ç—Ç–æ –æ—Å–Ω–æ–≤–∞ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏ –±—Ä–µ–Ω–¥–∞. –ï—Å–ª–∏ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –ª–æ–≥–æ—Ç–∏–ø, –Ω–æ–≤—ã–π –¥–∏–∑–∞–π–Ω –±—É–¥–µ—Ç –µ–≥–æ –¥–æ–ø–æ–ª–Ω—è—Ç—å. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –º—ã —Å–æ–∑–¥–∞–¥–∏–º –µ–≥–æ —Å –Ω—É–ª—è. –ß–∞—Å—Ç–∏—á–Ω–æ–µ –Ω–∞–ª–∏—á–∏–µ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –µ—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å.',
                    options: [
                        { text: '–î–∞, –µ—Å—Ç—å', value: '–î–∞' },
                        { text: '–ù–µ—Ç, –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å', value: '–ù–µ—Ç' },
                        { text: '–ß–∞—Å—Ç–∏—á–Ω–æ –µ—Å—Ç—å', value: '–ß–∞—Å—Ç–∏—á–Ω–æ' }
                    ]
                },
                {
                    key: 'q5_colors',
                    text: '–ö–∞–∫–∏–µ —Ü–≤–µ—Ç–∞ –≤–∞–º –Ω—Ä–∞–≤—è—Ç—Å—è?',
                    type: 'colors',
                    hasDetail: true,
                    detailText: '–¶–≤–µ—Ç–∞ –∏–≥—Ä–∞—é—Ç –æ–≥—Ä–æ–º–Ω—É—é —Ä–æ–ª—å –≤ –¥–∏–∑–∞–π–Ω–µ. –ö–∞–∂–¥—ã–π —Ü–≤–µ—Ç –Ω–µ—Å–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é —ç–º–æ—Ü–∏—é: —Å–∏–Ω–∏–π ‚Äî –¥–æ–≤–µ—Ä–∏–µ –∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ, –∫—Ä–∞—Å–Ω—ã–π ‚Äî —ç–Ω–µ—Ä–≥–∏—è –∏ —Å—Ç—Ä–∞—Å—Ç—å, –∑–µ–ª–µ–Ω—ã–π ‚Äî –ø—Ä–∏—Ä–æ–¥–∞ –∏ —Ä–æ—Å—Ç, –∂–µ–ª—Ç—ã–π ‚Äî –æ–ø—Ç–∏–º–∏–∑–º. –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ç–æ–≤—É—é –ø–∞–ª–∏—Ç—Ä—É –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é —Å –ø–æ–º–æ—â—å—é –∫–æ–ª–æ—Ä–ø–∏–∫–µ—Ä–∞.'
                },
                {
                    key: 'q6_style',
                    text: '–ö–∞–∫–æ–π —Å—Ç–∏–ª—å –¥–∏–∑–∞–π–Ω–∞ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ?',
                    type: 'style',
                    hasDetail: true,
                    detailText: '–°—Ç–∏–ª—å –¥–∏–∑–∞–π–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ–±—â—É—é —ç—Å—Ç–µ—Ç–∏–∫—É –ø—Ä–æ–µ–∫—Ç–∞. –ú–∏–Ω–∏–º–∞–ª–∏–∑–º ‚Äî –ø—Ä–æ—Å—Ç–æ—Ç–∞ –∏ —è—Å–Ω–æ—Å—Ç—å, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å. –Ø—Ä–∫–∏–µ —Ü–≤–µ—Ç–∞ ‚Äî —Å–º–µ–ª–æ—Å—Ç—å –∏ —ç–Ω–µ—Ä–≥–∏—è. –ì–µ–æ–º–µ—Ç—Ä–∏—è ‚Äî —á–µ—Ç–∫–∏–µ —Ñ–æ—Ä–º—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞. –ö–ª–∞—Å—Å–∏–∫–∞ ‚Äî –≤–µ—á–Ω–∞—è —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ—Å—Ç—å. –ú–æ–¥–µ—Ä–Ω ‚Äî —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã –∏ –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏.'
                },
                {
                    key: 'q7_references',
                    text: '–ï—Å—Ç—å –ª–∏ –ø—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –Ω—Ä–∞–≤—è—Ç—Å—è?',
                    type: 'file',
                    hasDetail: true,
                    detailText: '–†–µ—Ñ–µ—Ä–µ–Ω—Å—ã ‚Äî —ç—Ç–æ –ø—Ä–∏–º–µ—Ä—ã –¥–∏–∑–∞–π–Ω–∞, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –Ω—Ä–∞–≤—è—Ç—Å—è. –û–Ω–∏ –ø–æ–º–æ–≥–∞—é—Ç –¥–∏–∑–∞–π–Ω–µ—Ä—É –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å –≤–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–∞–π—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –Ω—Ä–∞–≤—è—Ç—Å—è.'
                },
                {
                    key: 'q8_deadline',
                    text: '–ö–∞–∫–∏–µ —Å—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞?',
                    type: 'text',
                    hasDetail: true,
                    detailText: '–°—Ä–æ–∫–∏ –≤–∞–∂–Ω—ã –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã. –£–∫–∞–∂–∏—Ç–µ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–µ–ª—å–Ω—É—é –¥–∞—Ç—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω. –ù–∞–ø—Ä–∏–º–µ—Ä: ¬´2 –Ω–µ–¥–µ–ª–∏¬ª, ¬´–¥–æ 15 —è–Ω–≤–∞—Ä—è¬ª –∏–ª–∏ ¬´—Å—Ä–æ—á–Ω–æ¬ª.',
                    hint: '–ù–∞–ø—Ä–∏–º–µ—Ä: 2 –Ω–µ–¥–µ–ª–∏, –¥–æ 31 –¥–µ–∫–∞–±—Ä—è'
                },
                {
                    key: 'q9_budget',
                    text: '–ö–∞–∫–æ–≤ –ø—Ä–∏–º–µ—Ä–Ω—ã–π –±—é–¥–∂–µ—Ç –ø—Ä–æ–µ–∫—Ç–∞?',
                    type: 'text',
                    fieldType: 'budget',
                    hasDetail: true,
                    detailText: '–ë—é–¥–∂–µ—Ç –ø–æ–º–æ–≥–∞–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–∞—Å—à—Ç–∞–± –ø—Ä–æ–µ–∫—Ç–∞ –∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è. –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏–º–µ—Ä–Ω—É—é —Å—É–º–º—É –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω. –ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–¥–æ 50 000 —Ä—É–±.¬ª, ¬´100 000 - 200 000 —Ä—É–±.¬ª –∏–ª–∏ ¬´–æ–≥–æ–≤–æ—Ä–∏–º –æ—Ç–¥–µ–ª—å–Ω–æ¬ª.',
                    hint: '–ù–∞–ø—Ä–∏–º–µ—Ä: 50 000 —Ä—É–±., 100-200–∫ —Ä—É–±.'
                }
            ];
            
            if (mode === 'web') {
                commonQuestions.splice(3, 0, 
                    {
                        key: 'q4_websiteType',
                        text: '–ö–∞–∫–æ–π —Ç–∏–ø —Å–∞–π—Ç–∞ –≤–∞–º –Ω—É–∂–µ–Ω?',
                        type: 'buttons',
                        hasDetail: true,
                        detailText: '–¢–∏–ø —Å–∞–π—Ç–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –µ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª. –õ–µ–Ω–¥–∏–Ω–≥ ‚Äî –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π —Å–∞–π—Ç –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ü–µ–ª–∏ (–ø—Ä–æ–¥–∞–∂–∞, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è). –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π ‚Äî –º–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π —Å–∞–π—Ç –∫–æ–º–ø–∞–Ω–∏–∏. –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω ‚Äî –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏. –ü–æ—Ä—Ç–∞–ª ‚Äî –∫—Ä—É–ø–Ω—ã–π —Å–∞–π—Ç —Å —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º.',
                        allowOther: true,
                        options: [
                            { text: '–õ–µ–Ω–¥–∏–Ω–≥', value: '–õ–µ–Ω–¥–∏–Ω–≥' },
                            { text: '–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π', value: '–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π' },
                            { text: '–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω', value: '–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω' },
                            { text: '–ü–æ—Ä—Ç–∞–ª', value: '–ü–æ—Ä—Ç–∞–ª' }
                        ]
                    },
                    {
                        key: 'qweb1_functionality',
                        text: '–ö–∞–∫–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∞ —Å–∞–π—Ç–µ?',
                        type: 'text',
                        hasDetail: true,
                        detailText: '–û–ø–∏—à–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª: —Ñ–æ—Ä–º—ã –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏, –∫–æ—Ä–∑–∏–Ω–∞, –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç, –ø–æ–∏—Å–∫, —Ñ–∏–ª—å—Ç—Ä—ã, —á–∞—Ç, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –ø–ª–∞—Ç—ë–∂–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ –∏ —Ç.–¥.',
                        hint: '–ù–∞–ø—Ä–∏–º–µ—Ä: —Ñ–æ—Ä–º–∞ –∑–∞—è–≤–∫–∏, –∫–æ—Ä–∑–∏–Ω–∞, –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç'
                    },
                    {
                        key: 'qweb2_responsive',
                        text: '–°–∞–π—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤?',
                        type: 'buttons',
                        hasDetail: true,
                        detailText: '–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö: —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞—Ö, –ø–ª–∞–Ω—à–µ—Ç–∞—Ö –∏ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞—Ö. –°–µ–≥–æ–¥–Ω—è —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–∞–π—Ç–æ–≤.',
                        options: [
                            { text: '–î–∞, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ', value: '–î–∞' },
                            { text: '–ù–µ—Ç, —Ç–æ–ª—å–∫–æ –¥–µ—Å–∫—Ç–æ–ø', value: '–ù–µ—Ç' },
                            { text: '–ù–µ —É–≤–µ—Ä–µ–Ω', value: '–ù–µ —É–≤–µ—Ä–µ–Ω' }
                        ]
                    },
                    {
                        key: 'qweb3_integrations',
                        text: '–ù—É–∂–Ω—ã –ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–∏—Å–∞–º–∏?',
                        type: 'text',
                        hasDetail: true,
                        detailText: '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏: CRM-—Å–∏—Å—Ç–µ–º—ã, –ø–ª–∞—Ç—ë–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (Google Analytics), email-—Ä–∞—Å—Å—ã–ª–∫–∏, —Å–æ—Ü—Å–µ—Ç–∏, –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã –∏ —Ç.–¥.',
                        hint: '–ù–∞–ø—Ä–∏–º–µ—Ä: CRM, –æ–ø–ª–∞—Ç–∞, Google Analytics'
                    },
                    {
                        key: 'qweb4_seo',
                        text: '–í–∞–∂–Ω–æ –ª–∏ SEO-–ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ?',
                        type: 'buttons',
                        hasDetail: true,
                        detailText: 'SEO (–ø–æ–∏—Å–∫–æ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è) –ø–æ–º–æ–≥–∞–µ—Ç —Å–∞–π—Ç—É –∑–∞–Ω–∏–º–∞—Ç—å –≤—ã—Å–æ–∫–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö. –ï—Å–ª–∏ –≤–∞–∂–Ω–æ ‚Äî –Ω—É–∂–Ω–æ —É—á–µ—Å—Ç—å —Å–µ–º–∞–Ω—Ç–∏–∫—É, –º–µ—Ç–∞-—Ç–µ–≥–∏, —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–∞–π—Ç–∞.',
                        options: [
                            { text: '–î–∞, –æ—á–µ–Ω—å –≤–∞–∂–Ω–æ', value: '–î–∞' },
                            { text: '–ù–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç', value: '–ù–µ—Ç' },
                            { text: '–ù–µ –∑–Ω–∞—é', value: '–ù–µ –∑–Ω–∞—é' }
                        ]
                    },
                    {
                        key: 'qweb5_content',
                        text: '–ö—Ç–æ –±—É–¥–µ—Ç –Ω–∞–ø–æ–ª–Ω—è—Ç—å —Å–∞–π—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º?',
                        type: 'text',
                        hasDetail: true,
                        detailText: '–í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å, –∫—Ç–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–µ–∫—Å—Ç—ã, —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏, –≤–∏–¥–µ–æ. –ï—Å–ª–∏ –≤—ã —Å–∞–º–∏ ‚Äî –Ω—É–∂–µ–Ω —É–¥–æ–±–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å. –ï—Å–ª–∏ –¥–∏–∑–∞–π–Ω–µ—Ä—ã ‚Äî –Ω—É–∂–Ω—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.',
                        hint: '–ù–∞–ø—Ä–∏–º–µ—Ä: —è —Å–∞–º, –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä, –∫–æ–Ω—Ç–µ–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä'
                    },
                    {
                        key: 'qweb6_languages',
                        text: '–ù—É–∂–Ω–∞ –ª–∏ –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å?',
                        type: 'buttons',
                        hasDetail: true,
                        detailText: '–ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É —è–∑—ã–∫–∞–º–∏. –í–∞–∂–Ω–æ –¥–ª—è –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤.',
                        options: [
                            { text: '–î–∞, –Ω—É–∂–Ω–∞', value: '–î–∞' },
                            { text: '–ù–µ—Ç', value: '–ù–µ—Ç' }
                        ]
                    },
                    {
                        key: 'qweb7_animation',
                        text: '–ù—É–∂–Ω—ã –ª–∏ –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤?',
                        type: 'buttons',
                        hasDetail: true,
                        detailText: '–ê–Ω–∏–º–∞—Ü–∏–∏ –¥–µ–ª–∞—é—Ç —Å–∞–π—Ç –∂–∏–≤—ã–º –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º, –Ω–æ –º–æ–≥—É—Ç –∑–∞–º–µ–¥–ª–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É. –í–∞–∂–Ω–æ –Ω–∞–π—Ç–∏ –±–∞–ª–∞–Ω—Å.',
                        options: [
                            { text: '–î–∞, –º–Ω–æ–≥–æ', value: '–î–∞, –º–Ω–æ–≥–æ' },
                            { text: '–î–∞, –º–∏–Ω–∏–º–∞–ª—å–Ω–æ', value: '–î–∞, –º–∏–Ω–∏–º–∞–ª—å–Ω–æ' },
                            { text: '–ù–µ—Ç', value: '–ù–µ—Ç' }
                        ]
                    }
                );
            }
            
            if (mode === 'polygraphy') {
                commonQuestions.splice(3, 0,
                    {
                        key: 'qpoly1_printtech',
                        text: '–ö–∞–∫–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ –ø–µ—á–∞—Ç–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è?',
                        type: 'text',
                        hasDetail: true,
                        detailText: '–¢–µ—Ö–Ω–∏–∫–∞ –ø–µ—á–∞—Ç–∏ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –º–∞–∫–µ—Ç–∞. –û—Ñ—Å–µ—Ç–Ω–∞—è ‚Äî –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∏—Ä–∞–∂–µ–π. –¶–∏—Ñ—Ä–æ–≤–∞—è ‚Äî –¥–ª—è –º–∞–ª—ã—Ö. –®–µ–ª–∫–æ–≥—Ä–∞—Ñ–∏—è ‚Äî –¥–ª—è —Ç–∫–∞–Ω–∏. –¢–∏—Å–Ω–µ–Ω–∏–µ, —Ñ–æ–ª—å–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –¥–ª—è –ø—Ä–µ–º–∏—É–º-–ø—Ä–æ–¥—É–∫—Ü–∏–∏.',
                        hint: '–ù–∞–ø—Ä–∏–º–µ—Ä: –æ—Ñ—Å–µ—Ç, —Ü–∏—Ñ—Ä–æ–≤–∞—è, —à–µ–ª–∫–æ–≥—Ä–∞—Ñ–∏—è'
                    },
                    {
                        key: 'qpoly2_format',
                        text: '–ö–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç –∏ —Ä–∞–∑–º–µ—Ä?',
                        type: 'text',
                        hasDetail: true,
                        detailText: '–£–∫–∞–∂–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç: A4, A5, A6, –µ–≤—Ä–æ—Ñ–ª–∞–µ—Ä, –≤–∏–∑–∏—Ç–∫–∞ 90x50–º–º, –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä. –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –≤—ë—Ä—Å—Ç–∫–∏.',
                        hint: '–ù–∞–ø—Ä–∏–º–µ—Ä: A4, A5, 90x50–º–º'
                    },
                    {
                        key: 'qpoly3_material',
                        text: '–ö–∞–∫–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª –±—É–º–∞–≥–∏?',
                        type: 'text',
                        hasDetail: true,
                        detailText: '–ú–∞—Ç–µ—Ä–∏–∞–ª –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ. –ú–µ–ª–æ–≤–∞–Ω–Ω–∞—è ‚Äî –≥–ª—è–Ω—Ü–µ–≤–∞—è, —è—Ä–∫–∞—è. –ú–∞—Ç–æ–≤–∞—è ‚Äî –Ω–µ–∂–Ω–∞—è, —ç–ª–µ–≥–∞–Ω—Ç–Ω–∞—è. –ö—Ä–∞—Ñ—Ç ‚Äî —ç–∫–æ-—Å—Ç–∏–ª—å. –î–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∞—è ‚Äî –ø—Ä–µ–º–∏—É–º.',
                        hint: '–ù–∞–ø—Ä–∏–º–µ—Ä: –º–µ–ª–æ–≤–∞–Ω–Ω–∞—è, –º–∞—Ç–æ–≤–∞—è, –∫—Ä–∞—Ñ—Ç'
                    },
                    {
                        key: 'qpoly4_folding',
                        text: '–ù—É–∂–Ω–∞ –ª–∏ —Å–∫–ª–∞–¥–∫–∞ –∏–ª–∏ —Ñ–∞–ª—å—Ü–æ–≤–∫–∞?',
                        type: 'buttons',
                        hasDetail: true,
                        detailText: '–°–∫–ª–∞–¥–∫–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ —Å–æ–∑–¥–∞—ë—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤–∏–¥—ã: –µ–≤—Ä–æ–±—É–∫–ª–µ—Ç, —Ç—Ä–∏–ø—Ç–∏—Ö, –≥–∞—Ä–º–æ—à–∫–∞.',
                        options: [
                            { text: '–î–∞, –Ω—É–∂–Ω–∞', value: '–î–∞' },
                            { text: '–ù–µ—Ç', value: '–ù–µ—Ç' },
                            { text: '–ù–µ –∑–Ω–∞—é', value: '–ù–µ –∑–Ω–∞—é' }
                        ]
                    },
                    {
                        key: 'qpoly5_finishing',
                        text: '–ù—É–∂–Ω–∞ –ª–∏ –ø–æ—Å–ª–µ–ø–µ—á–∞—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞?',
                        type: 'text',
                        hasDetail: true,
                        detailText: '–ü–æ—Å–ª–µ–ø–µ—á–∞—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–µ–º–∏—É–º: –ª–∞–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ç–∏—Å–Ω–µ–Ω–∏–µ, —Ñ–æ–ª—å–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –≤—ã–±–æ—Ä–æ—á–Ω—ã–π –£–§-–ª–∞–∫, –≤—ã—Ä—É–±–∫–∞, —Ç–µ—Ä–º–æ–ø–æ–¥—ä—ë–º.',
                        hint: '–ù–∞–ø—Ä–∏–º–µ—Ä: –ª–∞–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ñ–æ–ª—å–≥–∞, —Ç–∏—Å–Ω–µ–Ω–∏–µ'
                    }
                );
            }
            
            return commonQuestions;
        }

        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('DOMContentLoaded: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
                document.body.setAttribute('data-color-scheme', 'dark');
                if (typeof startChat === 'function') {
                    startChat();
                    console.log('‚úÖ startChat() –≤—ã–∑–≤–∞–Ω–∞');
                }
            } catch(e) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', e);
            }
        });

        window.addEventListener('load', function() {
            try {
                if (typeof startChat === 'function' && !document.body.hasAttribute('data-initialized')) {
                    console.log('window.load: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
                    document.body.setAttribute('data-initialized', 'true');
                }
            } catch(e) {
                console.error('–û—à–∏–±–∫–∞ –≤ window.load:', e);
            }
        });
</script>
</body>
</html>